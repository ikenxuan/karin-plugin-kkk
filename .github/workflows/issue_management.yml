name: Issue Management

on:
  schedule:
    - cron: "30 1 * * *"
  issues:
    types: [labeled, opened, edited]

jobs:
  # Issue æ ¼å¼éªŒè¯
  validate-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Check issue title
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title;
            const body = issue.body || '';
            
            const problems = [];
            
            // æ£€æŸ¥æ ‡é¢˜æ˜¯å¦åªæœ‰å‰ç¼€æ²¡æœ‰å®é™…å†…å®¹
            const bugPrefixOnly = /^Bug:\s*$/i.test(title);
            const featurePrefixOnly = /^Feature:\s*$/i.test(title);
            const emptyTitle = title.trim().length === 0;
            const tooShort = title.replace(/^(Bug|Feature):\s*/i, '').trim().length < 5;
            
            if (emptyTitle || bugPrefixOnly || featurePrefixOnly) {
              problems.push('âŒ **æ ‡é¢˜ä¸ºç©º**ï¼šè¯·åœ¨æ ‡é¢˜ä¸­ç®€è¦æè¿°ä½ çš„é—®é¢˜æˆ–å»ºè®®');
            } else if (tooShort) {
              problems.push('âš ï¸ **æ ‡é¢˜è¿‡çŸ­**ï¼šè¯·æä¾›æ›´å…·ä½“çš„æ ‡é¢˜æè¿°ï¼ˆè‡³å°‘ 5 ä¸ªå­—ç¬¦ï¼‰');
            }
            
            // æ£€æŸ¥æ˜¯å¦å¡«å†™äº†é—®é¢˜ç®€è¿°
            const hasSummary = body.includes('### é—®é¢˜ç®€è¿°') || body.includes('### åŠŸèƒ½ç®€è¿°');
            const summaryMatch = body.match(/### (?:é—®é¢˜|åŠŸèƒ½)ç®€è¿°\s*\n\s*(.+?)(?:\n|$)/);
            if (hasSummary && (!summaryMatch || summaryMatch[1].trim().length < 5)) {
              problems.push('âš ï¸ **ç®€è¿°è¿‡çŸ­**ï¼šè¯·åœ¨ã€Œé—®é¢˜ç®€è¿°ã€æˆ–ã€ŒåŠŸèƒ½ç®€è¿°ã€ä¸­æä¾›æ›´è¯¦ç»†çš„æè¿°');
            }
            
            if (problems.length > 0) {
              const warningBody = `
            ä½ å¥½ @${issue.user.login}ï¼Œæ„Ÿè°¢ä½ æäº¤ Issueï¼
            
            ä½†æ˜¯æˆ‘ä»¬å‘ç°äº†ä¸€äº›æ ¼å¼é—®é¢˜ï¼š
            
            ${problems.join('\n')}
            
            ---
            
            ğŸ“ **è¯·ç¼–è¾‘æ­¤ Issue**ï¼Œè¡¥å……ä»¥ä¸Šä¿¡æ¯åæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚
            
            > ğŸ’¡ æç¤ºï¼šä¸€ä¸ªå¥½çš„æ ‡é¢˜åº”è¯¥ç®€æ´æ˜äº†åœ°æè¿°é—®é¢˜ï¼Œä¾‹å¦‚ï¼š
            > - \`Bug: è§£ææŠ–éŸ³è§†é¢‘æ—¶æç¤º Cookie å¤±æ•ˆ\`
            > - \`Feature: æ”¯æŒè§£æå¾®åšè§†é¢‘\`
            `;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: warningBody
              });
              
              // æ·»åŠ  needs-info æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-info']
              });
            }

  # æ ‡ç­¾å›å¤
  label-greetings:
    if: github.event_name == 'issues' && github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Create comment for enhancement
        if: github.event.label.name == 'enhancement'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ä½ å¥½ @${{ github.event.issue.user.login }}ï¼Œæˆ‘ä»¬å·²ç»è®°å½•äº†ä½ çš„æ–°åŠŸèƒ½æè®®ã€‚å¦‚æœä½ æœ‰ä»»ä½•å…·ä½“çš„å®ç°æƒ³æ³•æˆ–è®¾è®¡è‰å›¾ï¼Œæ¬¢è¿éšæ—¶åˆ†äº«ç»™æˆ‘ä»¬ã€‚

      - name: Create comment for bug
        if: github.event.label.name == 'bug'
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            ä½ å¥½ @${{ github.event.issue.user.login }}ï¼Œçœ‹æ¥æˆ‘ä»¬çš„ä»£ç ä¸å°å¿ƒæ‰“äº†ä¸ªç›¹å„¿ã€‚åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬å·²ç»å”¤é†’äº†å¼€å‘å›¢é˜Ÿï¼Œä»–ä»¬æ­£å¿«é©¬åŠ é­åœ°èµ¶æ¥ä¿®å¤ï¼ğŸ”¨ğŸ

  # ç›¸ä¼¼æ€§åˆ†æ
  similarity-analysis:
    if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'edited')
    runs-on: ubuntu-latest
    steps:
      - name: analysis
        uses: actions-cool/issues-similarity-analysis@v1
        with:
          filter-threshold: 0.8
          comment-title: '### ä¼¼ä¹æœ‰ç›¸ä¼¼çš„é—®é¢˜'
          comment-body: '${index}. ${similarity} #${number}'
          show-footer: false
          show-mentioned: true
          since-days: 730
          exclude-labels: 'duplicate,invalid,needs-info'