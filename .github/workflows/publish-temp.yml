name: å‘å¸ƒä¸´æ—¶ç‰ˆæœ¬

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  publish-temp:
    runs-on: ubuntu-latest

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆç‰ˆæœ¬å·

      - name: å®‰è£…node
        uses: actions/setup-node@v4
        with:
          node-version: 21
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.7.1

      - name: è·å–å½“å‰æäº¤å“ˆå¸Œ
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SHORT_COMMIT_HASH=$SHORT_COMMIT_HASH" >> $GITHUB_ENV
          echo "REPO_URL=https://github.com/${{ github.repository }}/tree/$COMMIT_HASH" >> $GITHUB_ENV

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ä¿®æ”¹ç‰ˆæœ¬å·
        run: |
          # è·å–å½“å‰æ—¥æœŸä½œä¸ºç‰ˆæœ¬å·çš„ä¸€éƒ¨åˆ†
          DATE=$(date +'%Y%m%d')
          
          # ä»package.jsonè·å–å½“å‰ç‰ˆæœ¬å·
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          # ç”Ÿæˆæ–°çš„ç‰ˆæœ¬å·ï¼šä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.æ—¥æœŸ-çŸ­å“ˆå¸Œ
          BASE_VERSION=$(echo $CURRENT_VERSION | sed -E 's/([0-9]+\.[0-9]+)\.[0-9]+.*/\1/')
          NEW_VERSION="${BASE_VERSION}.${DATE}-${SHORT_COMMIT_HASH}"
          
          # æ›´æ–°package.jsonä¸­çš„ç‰ˆæœ¬å·
          npm version $NEW_VERSION --no-git-tag-version
          
          echo "PKG_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: ç¼–è¯‘
        run: pnpm build
        id: build
        continue-on-error: true

      - name: æ£€æŸ¥æ„å»ºç»“æœ
        if: steps.build.outcome != 'success'
        run: |
          echo "âŒ æ„å»ºå¤±è´¥ï¼" >> $GITHUB_STEP_SUMMARY
          echo "æäº¤å“ˆå¸Œ: ${{ env.SHORT_COMMIT_HASH }}" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: åˆ é™¤å¼€å‘ä¾èµ–
        run: npm run pr clean

      - name: åˆ›å»º pkg.pr.new é…ç½®æ–‡ä»¶
        run: |
          cat > .pkg.pr.new.json << EOF
          {
            "comment": {
              "header": "## ğŸ‰ ä¸´æ—¶NPMåŒ…å·²å‘å¸ƒ ğŸ“¦",
              "body": "ç‰ˆæœ¬å·: \`${PKG_VERSION}\`\nåŸºäºæäº¤: [\`${SHORT_COMMIT_HASH}\`](${REPO_URL})\n\n### å®‰è£…å‘½ä»¤\n\nä½¿ç”¨ pnpm:\n\`\`\`\npnpm add {{npmInstallUrl}} -w\n\`\`\`\n\nä½¿ç”¨ npm:\n\`\`\`\nnpm i {{npmInstallUrl}}\n\`\`\`",
              "footer": "å‘å¸ƒæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            }
          }
          EOF

      - name: å‘å¸ƒä¸´æ—¶NPMåŒ…
        id: publish_pkg
        run: |
          # å°†æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯éƒ½é‡å®šå‘åˆ°æ–‡ä»¶
          pnpm dlx pkg-pr-new publish > pkg-output.txt 2>&1
          
          # æ˜¾ç¤ºè¾“å‡ºå†…å®¹ä»¥ä¾¿åœ¨æ—¥å¿—ä¸­æŸ¥çœ‹
          echo "å‘½ä»¤è¾“å‡ºå†…å®¹ï¼š"
          cat pkg-output.txt
          
          # æå–å®‰è£…URLå¹¶è½¬æ¢ä¸ºpnpmæ ¼å¼
          INSTALL_URL=$(grep -E "npm i https://pkg.pr.new" pkg-output.txt | sed 's/.*npm i //' || echo "")
          
          if [ ! -z "$INSTALL_URL" ]; then
            PNPM_INSTALL_CMD="pnpm add $INSTALL_URL -w"
            NPM_INSTALL_CMD="npm i $INSTALL_URL"
          else
            PNPM_INSTALL_CMD="æœªæ‰¾åˆ°å®‰è£…å‘½ä»¤"
            NPM_INSTALL_CMD="æœªæ‰¾åˆ°å®‰è£…å‘½ä»¤"
          fi
          
          echo "pnpm_install_cmd=$PNPM_INSTALL_CMD" >> $GITHUB_OUTPUT
          echo "npm_install_cmd=$NPM_INSTALL_CMD" >> $GITHUB_OUTPUT
          
          # åœ¨å·¥ä½œæµæ‘˜è¦ä¸­æ·»åŠ ä¿¡æ¯
          echo "## ä¸´æ—¶NPMåŒ…å·²å‘å¸ƒ :package:" >> $GITHUB_STEP_SUMMARY
          echo "ç‰ˆæœ¬å·: \`${{ env.PKG_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "åŸºäºæäº¤: [\`${{ env.SHORT_COMMIT_HASH }}\`](${{ env.REPO_URL }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å®‰è£…å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "ä½¿ç”¨ pnpm:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$PNPM_INSTALL_CMD" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä½¿ç”¨ npm:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$NPM_INSTALL_CMD" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # æ·»åŠ å®Œæ•´è¾“å‡ºåˆ°æ‘˜è¦ï¼Œæ–¹ä¾¿æŸ¥çœ‹
          echo "## å®Œæ•´è¾“å‡º" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat pkg-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ NPMåŒ…ä¿¡æ¯
        uses: actions/upload-artifact@v4
        with:
          name: npm-package-info
          path: pkg-output.txt
          retention-days: 5

      - name: åˆ›å»º build.zip
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p temp-package
          
          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp -r lib temp-package/
          cp -r resources temp-package/
          cp package.json CHANGELOG.md README.md LICENSE temp-package/
          cp -r config temp-package/ || true
          
          # åˆ›å»ºzipæ–‡ä»¶
          cd temp-package
          zip -r ../build.zip .
          cd ..
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf temp-package

      - name: ä¸Šä¼  build.zip
        uses: actions/upload-artifact@v4
        with:
          name: build-zip
          path: build.zip
          retention-days: 5