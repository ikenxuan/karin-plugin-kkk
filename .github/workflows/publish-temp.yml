name: å‘å¸ƒä¸´æ—¶ç‰ˆæœ¬

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  publish-temp:
    runs-on: ubuntu-latest

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆç‰ˆæœ¬å·

      - name: å®‰è£…node
        uses: actions/setup-node@v4
        with:
          node-version: 21
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9.7.1

      - name: è·å–å½“å‰æäº¤å“ˆå¸Œ
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SHORT_COMMIT_HASH=$SHORT_COMMIT_HASH" >> $GITHUB_ENV
          echo "REPO_URL=https://github.com/${{ github.repository }}/tree/$COMMIT_HASH" >> $GITHUB_ENV

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ä¿®æ”¹ç‰ˆæœ¬å·
        run: |
          # è·å–å½“å‰æ—¥æœŸä½œä¸ºç‰ˆæœ¬å·çš„ä¸€éƒ¨åˆ†
          DATE=$(date +'%Y%m%d')
          
          # ä»package.jsonè·å–å½“å‰ç‰ˆæœ¬å·
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          # ç”Ÿæˆæ–°çš„ç‰ˆæœ¬å·ï¼šä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.æ—¥æœŸ-çŸ­å“ˆå¸Œ
          BASE_VERSION=$(echo $CURRENT_VERSION | sed -E 's/([0-9]+\.[0-9]+)\.[0-9]+.*/\1/')
          NEW_VERSION="${BASE_VERSION}.${DATE}-${SHORT_COMMIT_HASH}"
          
          # æ›´æ–°package.jsonä¸­çš„ç‰ˆæœ¬å·
          npm version $NEW_VERSION --no-git-tag-version
          
          echo "PKG_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: ç¼–è¯‘
        run: pnpm build
        id: build
        continue-on-error: true

      - name: æ£€æŸ¥æ„å»ºç»“æœ
        if: steps.build.outcome != 'success'
        run: |
          echo "âŒ æ„å»ºå¤±è´¥ï¼" >> $GITHUB_STEP_SUMMARY
          echo "æäº¤å“ˆå¸Œ: ${{ env.SHORT_COMMIT_HASH }}" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: åˆ é™¤å¼€å‘ä¾èµ–
        run: npm run pr clean

      - name: åˆ›å»º pkg.pr.new é…ç½®æ–‡ä»¶
        run: |
          cat > .pkg.pr.new.json << EOF
          {
            "comment": {
              "header": "## ğŸ‰ ä¸´æ—¶NPMåŒ…å·²å‘å¸ƒ ğŸ“¦",
              "body": "ç‰ˆæœ¬å·: \`${PKG_VERSION}\`\nåŸºäºæäº¤: [\`${SHORT_COMMIT_HASH}\`](${REPO_URL})\n\n### å®‰è£…å‘½ä»¤\n\nä½¿ç”¨ pnpm:\n\`\`\`\npnpm add {{npmInstallUrl}} -w\n\`\`\`\n\nä½¿ç”¨ npm:\n\`\`\`\nnpm i {{npmInstallUrl}}\n\`\`\`",
              "footer": "å‘å¸ƒæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            }
          }
          EOF

      - name: Publish packages
        run: pnpx pkg-pr-new publish --json output.json --comment=off

      - name: Post or update comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const output = JSON.parse(fs.readFileSync('output.json', 'utf8'));
      
            const packages = output.packages
              .map((p) => `- ${p.name}: ${p.url}`)
              .join('\n');
            const templates = output.templates
              .map((t) => `- [${t.name}](${t.url})`)
              .join('\n');
      
            const sha =
              context.event_name === 'pull_request'
                ? context.payload.pull_request.head.sha
                : context.payload.after;
      
            const commitUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${sha}`;
      
            const body = `## Custom Publish Message
      
            ### Published Packages:
      
            ${packages}
      
            ### Templates:
      
            ${templates}
      
            [View Commit](${commitUrl})`;
      
            const botCommentIdentifier = '## Custom Publish Message';
      
            async function findBotComment(issueNumber) {
              if (!issueNumber) return null;
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
              });
              return comments.data.find((comment) =>
                comment.body.includes(botCommentIdentifier)
              );
            }
      
            async function createOrUpdateComment(issueNumber) {
              if (!issueNumber) {
                console.log('No issue number provided. Cannot post or update comment.');
                return;
              }
      
              const existingComment = await findBotComment(issueNumber);
              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: body,
                });
              } else {
                await github.rest.issues.createComment({
                  issue_number: issueNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body,
                });
              }
            }
      
            async function logPublishInfo() {
              console.log('\n' + '='.repeat(50));
              console.log('Publish Information');
              console.log('='.repeat(50));
              console.log('\nPublished Packages:');
              console.log(packages);
              console.log('\nTemplates:');
              console.log(templates);
              console.log(`\nCommit URL: ${commitUrl}`);
              console.log('\n' + '='.repeat(50));
            }
      
            if (context.eventName === 'pull_request') {
              if (context.issue.number) {
                await createOrUpdateComment(context.issue.number);
              }
            } else if (context.eventName === 'push') {
              const pullRequests = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${context.ref.replace(
                  'refs/heads/',
                  ''
                )}`,
              });
      
              if (pullRequests.data.length > 0) {
                await createOrUpdateComment(pullRequests.data[0].number);
              } else {
                console.log(
                  'No open pull request found for this push. Logging publish information to console:'
                );
                await logPublishInfo();
              }
            }

      - name: åˆ›å»º build.zip
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p temp-package
          
          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp -r lib temp-package/
          cp -r resources temp-package/
          cp package.json CHANGELOG.md README.md LICENSE temp-package/
          cp -r config temp-package/ || true
          
          # åˆ›å»ºzipæ–‡ä»¶
          cd temp-package
          zip -r ../build.zip .
          cd ..
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf temp-package

      - name: ä¸Šä¼  build.zip
        uses: actions/upload-artifact@v4
        with:
          name: build-zip
          path: build.zip
          retention-days: 5