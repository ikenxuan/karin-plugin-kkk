name: CI/CD

on:
  workflow_dispatch:
    inputs:
      # æ‰‹åŠ¨è¿è¡Œæ¨¡å¼é€‰æ‹©
      run_mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      
      # æ‰‹åŠ¨å‘å¸ƒç‰ˆæœ¬å·ï¼ˆä»…ç”Ÿäº§æ¨¡å¼éœ€è¦ï¼‰
      manual_version:
        description: 'æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å· (å¦‚: 1.2.3ï¼Œä»…ç”Ÿäº§æ¨¡å¼æœ‰æ•ˆ)'
        required: false
        type: string
      
      # å‘å¸ƒè¯´æ˜Ž
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜Ž (å¯é€‰)'
        required: false
        type: string
      
      # æ˜¯å¦è·³è¿‡æ¡Œé¢åº”ç”¨æž„å»º
      skip_desktop:
        description: 'è·³è¿‡æ¡Œé¢åº”ç”¨æž„å»º'
        required: false
        default: false
        type: boolean
      
      # æ˜¯å¦å¼ºåˆ¶å‘å¸ƒåˆ° NPM
      force_npm_publish:
        description: 'å¼ºåˆ¶å‘å¸ƒåˆ° NPM (ä»…ç”Ÿäº§æ¨¡å¼)'
        required: false
        default: false
        type: boolean

  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]

env:
  APP_NAME: karin-plugin-kkk

permissions:
  contents: write
  id-token: write
  packages: write
  pull-requests: write

jobs:
  # ç‰ˆæœ¬å‘å¸ƒç®¡ç†
  version-release:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release-please.outputs.releases_created || steps.manual-release.outputs.releases_created }}
      core_release_created: ${{ steps.release-please.outputs['packages/core--release_created'] || steps.manual-release.outputs.core_release_created }}
      core_tag_name: ${{ steps.release-please.outputs['packages/core--tag_name'] || steps.manual-release.outputs.core_tag_name }}
      core_version: ${{ steps.get-version-info.outputs.core_version }}
      should_upload_release: ${{ steps.get-version-info.outputs.should_upload_release }}
      release_tag_name: ${{ steps.get-version-info.outputs.release_tag_name }}
      is_manual_production: ${{ steps.get-version-info.outputs.is_manual_production }}
      manual_release_notes: ${{ steps.get-version-info.outputs.manual_release_notes }}

    steps:
      - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # è‡ªåŠ¨ç‰ˆæœ¬å‘å¸ƒæ£€æŸ¥ï¼ˆéžæ‰‹åŠ¨ç”Ÿäº§æ¨¡å¼ï¼‰
      - name: ðŸš€ æ‰§è¡Œç‰ˆæœ¬å‘å¸ƒæ£€æŸ¥
        if: github.event_name != 'workflow_dispatch' || inputs.run_mode != 'production'
        id: release-please
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json
          release-please-version: "17.1.2"

      # æ‰‹åŠ¨ç”Ÿäº§å‘å¸ƒå¤„ç†
      - name: ðŸŽ¯ å¤„ç†æ‰‹åŠ¨ç”Ÿäº§å‘å¸ƒ
        if: github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production'
        id: manual-release
        run: |
          if [ -z "${{ inputs.manual_version }}" ]; then
            echo "âŒ ç”Ÿäº§æ¨¡å¼å¿…é¡»æŒ‡å®šç‰ˆæœ¬å·" >&2
            exit 1
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if ! echo "${{ inputs.manual_version }}" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º x.y.z æ ¼å¼" >&2
            exit 1
          fi
          
          echo "releases_created=true" >> $GITHUB_OUTPUT
          echo "core_release_created=true" >> $GITHUB_OUTPUT
          echo "core_tag_name=v${{ inputs.manual_version }}" >> $GITHUB_OUTPUT
          
          echo "âœ… æ‰‹åŠ¨ç”Ÿäº§å‘å¸ƒå·²é…ç½®ï¼šv${{ inputs.manual_version }}"

      - name: ðŸ·ï¸ èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
        id: get-version-info
        run: |
          cd packages/core
          
          # å¤„ç†æ‰‹åŠ¨ç”Ÿäº§æ¨¡å¼
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.run_mode }}" = "production" ]; then
            # æ‰‹åŠ¨æ›´æ–° package.json ç‰ˆæœ¬å·
            npm version ${{ inputs.manual_version }} --no-git-tag-version
            CORE_VERSION="${{ inputs.manual_version }}"
            echo "should_upload_release=true" >> $GITHUB_OUTPUT
            echo "release_tag_name=v${{ inputs.manual_version }}" >> $GITHUB_OUTPUT
            echo "is_manual_production=true" >> $GITHUB_OUTPUT
            echo "manual_release_notes=${{ inputs.release_notes }}" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ æ‰‹åŠ¨ç”Ÿäº§æ¨¡å¼ï¼šç‰ˆæœ¬ $CORE_VERSION"
          else
            # è‡ªåŠ¨æ¨¡å¼æˆ–é¢„è§ˆæ¨¡å¼
            CORE_VERSION=$(node -p "require('./package.json').version")
            echo "is_manual_production=false" >> $GITHUB_OUTPUT
            echo "manual_release_notes=" >> $GITHUB_OUTPUT
            
            if [ "${{ steps.release-please.outputs.core_release_created }}" = "true" ] || [ "${{ inputs.force_npm_publish }}" = "true" ]; then
              echo "should_upload_release=true" >> $GITHUB_OUTPUT
              echo "release_tag_name=${{ steps.release-please.outputs.core_tag_name }}" >> $GITHUB_OUTPUT
            else
              echo "should_upload_release=false" >> $GITHUB_OUTPUT
              echo "release_tag_name=" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "core_version=$CORE_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ å½“å‰ç‰ˆæœ¬ï¼š$CORE_VERSION"

  # ç»Ÿä¸€æž„å»ºä½œä¸šï¼ˆä»…æ ¸å¿ƒåŒ…å’ŒWebåº”ç”¨ï¼‰
  unified-build:
    runs-on: ubuntu-latest
    needs: [version-release]
    outputs:
      build_success: ${{ steps.build-status.outputs.success }}
      package_name: ${{ steps.package-info.outputs.name }}
      package_short_name: ${{ steps.package-info.outputs.short_name }}
      commit_hash: ${{ steps.git-info.outputs.commit_hash }}
      short_commit_hash: ${{ steps.git-info.outputs.short_commit_hash }}
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ é…ç½® PNPM çŽ¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: ðŸŸ¢ é…ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ”¨ æ‰§è¡Œå®Œæ•´é¡¹ç›®æž„å»º
        run: |
          echo "å¼€å§‹æž„å»ºæ‰€æœ‰åŒ…..."
          pnpm build
          if [ $? -ne 0 ]; then
            echo "âŒ æž„å»ºå¤±è´¥ï¼Œé€€å‡ºå·¥ä½œæµ"
            exit 1
          fi
          echo "âœ… æž„å»ºæˆåŠŸ"

      - name: ðŸ·ï¸ èŽ·å–åŒ…ä¿¡æ¯
        id: package-info
        working-directory: packages/core
        run: |
          PACKAGE_NAME=$(pnpm pkg get name | tr -d '"')
          PACKAGE_SHORT_NAME=$(basename "$PACKAGE_NAME")
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "short_name=$PACKAGE_SHORT_NAME" >> $GITHUB_OUTPUT

      - name: ðŸ“Š èŽ·å– Git ä¿¡æ¯
        id: git-info
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "short_commit_hash=$SHORT_COMMIT_HASH" >> $GITHUB_OUTPUT

      # æ‰‹åŠ¨ç”Ÿäº§æ¨¡å¼ï¼šåº”ç”¨ç‰ˆæœ¬å·å˜æ›´
      - name: ðŸŽ¯ åº”ç”¨æ‰‹åŠ¨ç‰ˆæœ¬å·
        if: github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production'
        run: |
          cd packages/core
          npm version ${{ inputs.manual_version }} --no-git-tag-version
          echo "âœ… å·²åº”ç”¨æ‰‹åŠ¨ç‰ˆæœ¬å·ï¼š${{ inputs.manual_version }}"

      - name: ðŸ“¦ å‡†å¤‡å‘å¸ƒäº§ç‰© (æ­£å¼ç‰ˆ)
        if: needs.version-release.outputs.core_release_created == 'true' || (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production')
        run: |
          cd packages/core
          pnpm pkg delete devDependencies
          mkdir -p ${{ runner.temp }}/production/
          cp -r package.json README.md CHANGELOG.md LICENSE config resources lib ${{ runner.temp }}/production/

      - name: ðŸ“¦ å‡†å¤‡æž„å»ºåˆ†æ”¯äº§ç‰©
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cd packages/core
          pnpm pkg delete devDependencies
          mkdir -p ${{ runner.temp }}/build-branch/
          cp -r package.json CHANGELOG.md README.md LICENSE resources config lib ${{ runner.temp }}/build-branch/

      - name: ðŸ“¦ å‡†å¤‡é¢„è§ˆåŒ…äº§ç‰©
        if: github.event_name != 'workflow_dispatch' || inputs.run_mode != 'production'
        run: |
          cd packages/core
          mkdir -p ${{ runner.temp }}/preview/
          cp -r package.json README.md CHANGELOG.md LICENSE config resources lib ${{ runner.temp }}/preview/

      - name: ðŸ“¤ ä¸Šä¼ æ­£å¼ç‰ˆæž„å»ºäº§ç‰©
        if: needs.version-release.outputs.core_release_created == 'true' || (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production')
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: ${{ runner.temp }}/production/

      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºåˆ†æ”¯äº§ç‰©
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: build-branch-artifacts
          path: ${{ runner.temp }}/build-branch/

      - name: ðŸ“¤ ä¸Šä¼ é¢„è§ˆåŒ…äº§ç‰©
        if: github.event_name != 'workflow_dispatch' || inputs.run_mode != 'production'
        uses: actions/upload-artifact@v4
        with:
          name: preview-build
          path: ${{ runner.temp }}/preview/

      - name: âœ… æ ‡è®°æž„å»ºçŠ¶æ€
        id: build-status
        run: echo "success=true" >> $GITHUB_OUTPUT

  # NPM æ­£å¼å‘å¸ƒ
  npm-production-publish:
    runs-on: ubuntu-latest
    needs: [version-release, unified-build]
    if: |
      needs.unified-build.outputs.build_success == 'true' && (
        needs.version-release.outputs.core_release_created == 'true' ||
        (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production') ||
        inputs.force_npm_publish == true
      )
    steps:
      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: ./

      - name: ðŸš€ å‘å¸ƒåˆ° NPM å®˜æ–¹æº
        id: publish-to-npm
        uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
          registry: https://registry.npmjs.org/
          access: public
          provenance: true

      - name: ðŸ“Š ç”Ÿæˆå‘å¸ƒæŠ¥å‘Š
        run: |
          echo "## ðŸ“¦ NPM å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒ…å:** \`${{ steps.publish-to-npm.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`${{ steps.publish-to-npm.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¨¡å¼:** ${{ github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production' && 'ðŸŽ¯ æ‰‹åŠ¨ç”Ÿäº§å‘å¸ƒ' || 'ðŸ¤– è‡ªåŠ¨å‘å¸ƒ' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.version-release.outputs.manual_release_notes }}" != "" ]; then
            echo "- **å‘å¸ƒè¯´æ˜Ž:** ${{ needs.version-release.outputs.manual_release_notes }}" >> $GITHUB_STEP_SUMMARY
          fi

  # é•œåƒæºåŒæ­¥
  npm-mirror-sync:
    runs-on: ubuntu-latest
    needs: [npm-production-publish]
    steps:
      - name: ðŸ”„ åŒæ­¥åˆ°å›½å†…é•œåƒæº
        run: |
          curl -X PUT "https://registry-direct.npmmirror.com/-/package/karin-plugin-kkk/syncs"

  # æž„å»ºåˆ†æ”¯åŒæ­¥
  build-branch-sync:
    runs-on: ubuntu-latest
    needs: [unified-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.unified-build.outputs.build_success == 'true'
    outputs:
      build_completed: ${{ steps.build-success.outputs.completed }}
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-branch-artifacts
          path: ${{ runner.temp }}/build-artifacts/
      
      - name: âœ… æ ‡è®°æž„å»ºå®Œæˆ
        id: build-success
        run: echo "completed=true" >> $GITHUB_OUTPUT
      
      - name: âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ”„ åŒæ­¥ä¸»åˆ†æ”¯æœ€æ–°ä»£ç 
        run: |
          git fetch origin ${{ github.ref_name }}
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }} --ff-only

      - name: ðŸ” æ£€æŸ¥æž„å»ºåˆ†æ”¯çŠ¶æ€
        id: check-branch
        run: |
          if git ls-remote --exit-code origin build; then
            echo "branch_exists=true" >> $GITHUB_ENV
          else
            echo "branch_exists=false" >> $GITHUB_ENV
          fi

      - name: ðŸŒ¿ åˆå§‹åŒ–æž„å»ºåˆ†æ”¯
        run: |          
          if [ "${{ env.branch_exists }}" = "false" ]; then
            git checkout --orphan build
            git reset --hard
            git clean -fd
            git commit --allow-empty -m "åˆå§‹åŒ–ç¼–è¯‘åˆ†æ”¯"
            git push --set-upstream -f origin build
          else
            git fetch origin build
            git reset --hard
            git clean -fd
            git reset --hard origin/build
            git checkout build
          fi

      - name: ðŸ—‚ï¸ å‡†å¤‡æž„å»ºæ–‡ä»¶
        run: |
          find . -mindepth 1 -maxdepth 1 -not -name '.git' -exec rm -rf {} \;
          cp -rv ${{ runner.temp }}/build-artifacts/* ./

      - name: ðŸ’¾ æäº¤æž„å»ºç»“æžœ
        run: |
          git add .
          if [ -z "$(git diff --cached --name-only)" ]; then
            echo "No changes detected"
            exit 0
          else
            git commit -m "chore(build): æž„å»ºåˆ†æ”¯åŒæ­¥"
          fi

      - name: ðŸš€ æŽ¨é€åˆ°æž„å»ºåˆ†æ”¯
        uses: ad-m/github-push-action@master
        with:
          branch: build
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force_with_lease: true

  # é¢„è§ˆåŒ…å‘å¸ƒï¼ˆä¼˜å…ˆæ‰§è¡Œï¼‰
  preview-package-publish:
    runs-on: ubuntu-latest
    needs: [unified-build]
    if: needs.unified-build.outputs.build_success == 'true' && (github.event_name != 'workflow_dispatch' || inputs.run_mode != 'production')
    outputs:
      pkg_version: ${{ steps.version-gen.outputs.version }}
      pnpm_install_cmd: ${{ steps.publish_pkg.outputs.pnpm_install_cmd }}
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ é…ç½® PNPM çŽ¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: ðŸŸ¢ é…ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: preview-build
          path: ./

      - name: ðŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡è¯†
        id: version-gen
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          COMMIT_COUNT=$(git rev-list --count HEAD)
          TIMESTAMP=$(date +%s)
          
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [[ "${{ github.head_ref }}" == release-please--branches--* ]]; then
              TIME_SUFFIX=$(TZ='Asia/Shanghai' date +%m%d%H%M)
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-rc.${TIME_SUFFIX}"
            else
              PR_NUMBER=${{ github.event.number }}
              PR_COMMIT_COUNT=$(git rev-list --count HEAD ^origin/main)
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-alpha.${PR_NUMBER}.${PR_COMMIT_COUNT}"
            fi
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            TIME_SUFFIX=$(echo $TIMESTAMP | tail -c 5)
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-beta.${COMMIT_COUNT}.${TIME_SUFFIX}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TIME_SUFFIX=$(TZ='Asia/Shanghai' date +%m%d%H%M)
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-manual.${TIME_SUFFIX}"
          else
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-dev.${BRANCH_NAME}.${{ needs.unified-build.outputs.short_commit_hash }}"
          fi
          
          npm version $NEW_VERSION --no-git-tag-version
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ§¹ æ¸…ç†å¼€å‘ä¾èµ–
        run: pnpm pkg delete devDependencies

      - name: ðŸš€ å‘å¸ƒé¢„è§ˆåŒ…
        id: publish_pkg
        run: |
          pnpm dlx pkg-pr-new publish --json output.json --comment=update --compact --packageManager=pnpm > pkg-output.txt 2>&1
          
          ACTUAL_INSTALL_URL=$(grep -oE 'https://pkg\.pr\.new/[^[:space:]`]+' pkg-output.txt | head -n 1 || echo "")
          
          if [ ! -z "$ACTUAL_INSTALL_URL" ]; then
            PNPM_INSTALL_CMD="pnpm add ${ACTUAL_INSTALL_URL} -w"
          else
            PNPM_INSTALL_CMD="æœªæ‰¾åˆ°å®‰è£…å‘½ä»¤"
          fi
          
          echo "pnpm_install_cmd=$PNPM_INSTALL_CMD" >> $GITHUB_OUTPUT

      - name: ðŸ’¬ å‘å¸ƒ PR è¯„è®º
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## ðŸ“¦ é¢„è§ˆåŒ…å‘å¸ƒæˆåŠŸ
            
            ### ðŸ·ï¸ åŒ…ä¿¡æ¯
            - **ç‰ˆæœ¬:** `${{ steps.version-gen.outputs.version }}`
            - **æäº¤:** [`${{ needs.unified-build.outputs.short_commit_hash }}`](https://github.com/${{ github.repository }}/tree/${{ needs.unified-build.outputs.commit_hash }})
            
            ### ðŸ“¥ å®‰è£…å‘½ä»¤
            ```bash
            ${{ steps.publish_pkg.outputs.pnpm_install_cmd }}
            ```
            
            ### ðŸ–¥ï¸ Windows æ¡Œé¢åº”ç”¨
            ${{ inputs.skip_desktop == true && '- **çŠ¶æ€:** â­ï¸ å·²è·³è¿‡æž„å»º' || '- **çŠ¶æ€:** ðŸ”„ æž„å»ºä¸­...' }}
            
            ### ðŸ“± Android åº”ç”¨
            ${{ inputs.skip_desktop == true && '- **çŠ¶æ€:** â­ï¸ å·²è·³è¿‡æž„å»º' || '- **çŠ¶æ€:** ðŸ”„ æž„å»ºä¸­...' }}
            ${{ inputs.skip_desktop != true && '- **æž¶æž„:** aarch64' || '' }}
            
            ---
            ${{ inputs.skip_desktop != true && '> ðŸ’¡ æ¡Œé¢å’Œç§»åŠ¨åº”ç”¨æž„å»ºå®ŒæˆåŽå°†è‡ªåŠ¨æ›´æ–°æ­¤è¯„è®º' || '' }}
          comment-tag: published-packages
          mode: upsert
          reactions: rocket

  # æ¡Œé¢åº”ç”¨ EXE æž„å»º
  desktop-build:
    runs-on: ubuntu-latest
    needs: [version-release, unified-build, preview-package-publish]
    if: |
      needs.unified-build.outputs.build_success == 'true' && 
      (github.event_name != 'workflow_dispatch' || inputs.skip_desktop != true) &&
      (needs.preview-package-publish.result == 'success' || needs.version-release.outputs.should_upload_release == 'true')
    outputs:
      desktop_build_success: ${{ steps.desktop-build.outputs.success }}
      desktop_version: ${{ steps.sync-desktop-version.outputs.desktop_version }}
      desktop_exe_name: ${{ steps.desktop-build.outputs.exe_name }}
      desktop_artifact_url: ${{ steps.desktop-summary.outputs.artifact_url }}
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ å®‰è£…æž„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64 nsis build-essential

      - name: ðŸ¦€ å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-gnu

      - name: ðŸ’¾ ç¼“å­˜ Rust ä¾èµ–
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/web/src-tauri
          cache-on-failure: true
          shared-key: ${{ env.APP_NAME }}-desktop-build

      - name: ðŸ“¦ é…ç½® PNPM çŽ¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: ðŸŸ¢ é…ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ”„ åŒæ­¥ç‰ˆæœ¬å·åˆ°æ¡Œé¢åº”ç”¨é…ç½®
        id: sync-desktop-version
        run: |
          CORE_VERSION="${{ needs.version-release.outputs.core_version }}"
          echo "åŒæ­¥ç‰ˆæœ¬å·: $CORE_VERSION"
          
          # æ›´æ–° tauri.conf.json ä¸­çš„ç‰ˆæœ¬å·
          configPath="packages/web/src-tauri/tauri.conf.json"
          jq --arg version "$CORE_VERSION" '.version = $version' "$configPath" > tmp.json && mv tmp.json "$configPath"
          
          # æ›´æ–° Cargo.toml ä¸­çš„ç‰ˆæœ¬å·
          cargoPath="packages/web/src-tauri/Cargo.toml"
          sed -i "s/^version = \".*\"/version = \"$CORE_VERSION\"/" "$cargoPath"
          
          echo "desktop_version=$CORE_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·å·²åŒæ­¥ä¸º: $CORE_VERSION"

      - name: ðŸ”§ é…ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
        run: |
          # è®¾ç½® MinGW å·¥å…·é“¾çŽ¯å¢ƒå˜é‡
          echo "CC_x86_64_pc_windows_gnu=x86_64-w64-mingw32-gcc" >> $GITHUB_ENV
          echo "CXX_x86_64_pc_windows_gnu=x86_64-w64-mingw32-g++" >> $GITHUB_ENV
          echo "AR_x86_64_pc_windows_gnu=x86_64-w64-mingw32-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=x86_64-w64-mingw32-gcc" >> $GITHUB_ENV
          
          # éªŒè¯å·¥å…·é“¾
          x86_64-w64-mingw32-gcc --version
          x86_64-w64-mingw32-g++ --version

      - name: ðŸ“± æž„å»ºæ¡Œé¢åº”ç”¨ (Windows)
        id: desktop-build
        run: |
          echo "å¼€å§‹æž„å»ºæ¡Œé¢åº”ç”¨..."
          
          cd packages/web
          
          # è®¾ç½®è¯¦ç»†æ—¥å¿—
          export RUST_LOG=info
          
          # æž„å»ºæ¡Œé¢åº”ç”¨ (ä½¿ç”¨ GNU å·¥å…·é“¾)
          echo "ðŸš€ å¼€å§‹æž„å»º (ä½¿ç”¨ GNU å·¥å…·é“¾)..."
          if pnpm tauri build --target x86_64-pc-windows-gnu; then
            echo "success=true" >> $GITHUB_OUTPUT
            
            # æŸ¥æ‰¾å®‰è£…ç¨‹åº
            INSTALLER_PATH=$(find "$PWD/src-tauri/target/x86_64-pc-windows-gnu/release/bundle" -type f \( -name "*.exe" -o -name "*.msi" \) 2>/dev/null | head -1)
            
            if [ -n "$INSTALLER_PATH" ]; then
              INSTALLER_NAME=$(basename "$INSTALLER_PATH")
              RELATIVE_PATH=$(realpath --relative-to="$PWD" "$INSTALLER_PATH")
              echo "exe_path=$RELATIVE_PATH" >> $GITHUB_OUTPUT
              echo "exe_name=$INSTALLER_NAME" >> $GITHUB_OUTPUT
              echo "âœ… æ‰¾åˆ°å®‰è£…ç¨‹åº: $INSTALLER_PATH"
            else
              echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å®‰è£…ç¨‹åº"
              echo "ðŸ” åˆ—å‡ºæž„å»ºäº§ç‰©:"
              find src-tauri/target -name "*.exe" -o -name "*.msi" 2>/dev/null || echo "æ— æž„å»ºäº§ç‰©"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "âŒ æ¡Œé¢åº”ç”¨æž„å»ºå¤±è´¥"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ“¤ ä¸Šä¼ æ¡Œé¢åº”ç”¨æž„å»ºäº§ç‰©
        if: steps.desktop-build.outputs.success == 'true'
        id: upload-desktop-artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.desktop-build.outputs.exe_name }}
          path: packages/web/${{ steps.desktop-build.outputs.exe_path }}
          retention-days: 30
          compression-level: 0

      - name: ðŸš€ ä¸Šä¼ åˆ°Release
        if: |
          steps.desktop-build.outputs.success == 'true' && 
          needs.version-release.outputs.should_upload_release == 'true' && 
          needs.version-release.outputs.release_tag_name != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version-release.outputs.release_tag_name }}
          files: packages/web/${{ steps.desktop-build.outputs.exe_path }}
          name: ${{ steps.desktop-build.outputs.exe_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š ç”Ÿæˆæ¡Œé¢åº”ç”¨ä¿¡æ¯
        if: steps.desktop-build.outputs.success == 'true'
        id: desktop-summary
        run: |
          ARTIFACT_ID="${{ steps.upload-desktop-artifact.outputs.artifact-id }}"
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/$ARTIFACT_ID"
          echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
          
          echo "## ðŸ–¥ï¸ Windowsæ¡Œé¢åº”ç”¨æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± åº”ç”¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°:** Windows x64" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶å:** \`${{ steps.desktop-build.outputs.exe_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`${{ steps.sync-desktop-version.outputs.desktop_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸºäºŽCoreç‰ˆæœ¬:** \`${{ needs.version-release.outputs.core_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **ç›´æŽ¥ä¸‹è½½:** [ç‚¹å‡»ä¸‹è½½ ${{ steps.desktop-build.outputs.exe_name }}]($ARTIFACT_URL)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.version-release.outputs.should_upload_release }}" = "true" ] && [ "${{ needs.version-release.outputs.release_tag_name }}" != "" ]; then
            echo "- ðŸš€ **Releaseä¸‹è½½:** [ç‚¹å‡»è¿™é‡Œä¸‹è½½æœ€æ–°ç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/tag/${{ needs.version-release.outputs.release_tag_name }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Android APK æž„å»º
  android-build:
    runs-on: ubuntu-latest
    needs: [version-release, unified-build, preview-package-publish]
    if: |
      needs.unified-build.outputs.build_success == 'true' && 
      (github.event_name != 'workflow_dispatch' || inputs.skip_desktop != true) &&
      (needs.preview-package-publish.result == 'success' || needs.version-release.outputs.should_upload_release == 'true')
    outputs:
      android_build_success: ${{ steps.android-build.outputs.success }}
      android_version: ${{ steps.sync-android-version.outputs.android_version }}
      android_apk_name: ${{ steps.android-build.outputs.apk_name }}
      android_artifact_url: ${{ steps.android-summary.outputs.artifact_url }}
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¤– é…ç½® Gradle çŽ¯å¢ƒ
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper

      - name: ðŸ¤– é…ç½® Android å¼€å‘çŽ¯å¢ƒ
        uses: android-actions/setup-android@v3

      - name: ðŸ¦€ å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: ðŸ’¾ ç¼“å­˜ Rust ä¾èµ–å’Œæž„å»ºäº§ç‰©
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/web/src-tauri
          cache-on-failure: true
          shared-key: ${{ env.APP_NAME }}-android-build

      - name: ðŸ’¾ ç¼“å­˜ Gradle ä¾èµ–å’Œæž„å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            packages/web/src-tauri/gen/android/.gradle
            packages/web/src-tauri/gen/android/app/build
            packages/web/src-tauri/gen/android/app/.cxx
          key: gradle-${{ runner.os }}-${{ hashFiles('packages/web/src-tauri/gen/android/**/*.gradle*', 'packages/web/src-tauri/gen/android/**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: ðŸ’¾ ç¼“å­˜ Android æž„å»ºäº§ç‰©
        uses: actions/cache@v4
        with:
          path: |
            packages/web/src-tauri/gen/android/app/build/intermediates
            packages/web/src-tauri/gen/android/app/build/generated
            packages/web/src-tauri/gen/android/app/build/kotlin
            packages/web/src-tauri/gen/android/app/build/tmp
            packages/web/src-tauri/gen/android/app/src/main/jniLibs
          key: android-build-${{ runner.os }}-${{ hashFiles('packages/web/src-tauri/Cargo.toml', 'packages/web/src-tauri/src/**/*.rs') }}
          restore-keys: |
            android-build-${{ runner.os }}-

      - name: ðŸ” æ£€æŸ¥ç¼“å­˜æ¢å¤çŠ¶æ€
        run: |
          echo "=== Rust Target ç›®å½•çŠ¶æ€ ==="
          if [ -d "packages/web/src-tauri/target" ]; then
            echo "âœ… Rust targetç›®å½•å­˜åœ¨"
            ls -la packages/web/src-tauri/target/
            if [ -d "packages/web/src-tauri/target/aarch64-linux-android" ]; then
              echo "âœ… Android targetå­˜åœ¨"
              ls -la packages/web/src-tauri/target/aarch64-linux-android/
            else
              echo "âŒ Android targetä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°æž„å»º"
            fi
          else
            echo "âŒ Rust targetç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo "=== Android æž„å»ºç¼“å­˜çŠ¶æ€ ==="
          if [ -d "packages/web/src-tauri/gen/android/app/build" ]; then
            echo "âœ… Androidæž„å»ºç›®å½•å­˜åœ¨"
            ls -la packages/web/src-tauri/gen/android/app/build/
          else
            echo "âŒ Androidæž„å»ºç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo "=== JNIåº“çŠ¶æ€ ==="
          if [ -d "packages/web/src-tauri/gen/android/app/src/main/jniLibs" ]; then
            echo "âœ… JNIåº“ç›®å½•å­˜åœ¨"
            find packages/web/src-tauri/gen/android/app/src/main/jniLibs -name "*.so" | head -10
          else
            echo "âŒ JNIåº“ç›®å½•ä¸å­˜åœ¨"
          fi

      - name: â˜• é…ç½® Java çŽ¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“¦ é…ç½® PNPM çŽ¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: ðŸŸ¢ é…ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ðŸ”§ é…ç½® Android æž„å»ºçŽ¯å¢ƒ
        run: |
          # è®¾ç½® Android çŽ¯å¢ƒå˜é‡
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          
          # æ˜Žç¡®è®¾ç½®NDKè·¯å¾„
          NDK_VERSION="28.2.13676358"
          NDK_PATH="$ANDROID_SDK_ROOT/ndk/$NDK_VERSION"
          
          # éªŒè¯NDKæ˜¯å¦å­˜åœ¨
          if [ ! -d "$NDK_PATH" ]; then
            echo "âŒ NDK $NDK_VERSION æœªæ‰¾åˆ°ï¼Œå°è¯•å®‰è£…..."
            $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "ndk;$NDK_VERSION"
            
            # å†æ¬¡æ£€æŸ¥
            if [ ! -d "$NDK_PATH" ]; then
              echo "âŒ NDK å®‰è£…å¤±è´¥ï¼ŒæŸ¥æ‰¾å¯ç”¨ç‰ˆæœ¬..."
              ls -la $ANDROID_SDK_ROOT/ndk/
              # ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªNDKç‰ˆæœ¬
              NDK_PATH=$(find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d -name "*.*.*" | head -1)
              if [ -z "$NDK_PATH" ]; then
                echo "âŒ æœªæ‰¾åˆ°ä»»ä½•NDKç‰ˆæœ¬"
                exit 1
              fi
              NDK_VERSION=$(basename "$NDK_PATH")
            fi
          fi
          
          echo "NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$NDK_PATH" >> $GITHUB_ENV
          echo "âœ… NDK è·¯å¾„è®¾ç½®ä¸º: $NDK_PATH (ç‰ˆæœ¬: $NDK_VERSION)"
          
          # éªŒè¯é“¾æŽ¥å™¨æ˜¯å¦å­˜åœ¨
          LINKER_PATH="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android36-clang"
          if [ ! -f "$LINKER_PATH" ]; then
            echo "âŒ é“¾æŽ¥å™¨ä¸å­˜åœ¨: $LINKER_PATH"
            echo "æŸ¥æ‰¾å¯ç”¨çš„é“¾æŽ¥å™¨..."
            find $NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/ -name "aarch64-linux-android*-clang" | head -5
            
            # å°è¯•ä½¿ç”¨å¯ç”¨çš„APIçº§åˆ«
            AVAILABLE_LINKER=$(find $NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/ -name "aarch64-linux-android*-clang" | head -1)
            if [ -n "$AVAILABLE_LINKER" ]; then
              API_LEVEL=$(basename "$AVAILABLE_LINKER" | sed 's/aarch64-linux-android\([0-9]*\)-clang/\1/')
              echo "âœ… ä½¿ç”¨å¯ç”¨çš„APIçº§åˆ«: $API_LEVEL"
              LINKER_PATH="$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${API_LEVEL}-clang"
            else
              echo "âŒ æœªæ‰¾åˆ°ä»»ä½•aarch64é“¾æŽ¥å™¨"
              exit 1
            fi
          fi
          
          # é…ç½® Rust äº¤å‰ç¼–è¯‘å·¥å…·é“¾
          echo "CC_aarch64_linux_android=$LINKER_PATH" >> $GITHUB_ENV
          echo "CXX_aarch64_linux_android=${LINKER_PATH}++" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$LINKER_PATH" >> $GITHUB_ENV
          
          echo "âœ… Rustäº¤å‰ç¼–è¯‘çŽ¯å¢ƒé…ç½®å®Œæˆ"

      # åŒæ­¥ç‰ˆæœ¬å·åˆ° Android é…ç½®
      - name: ðŸ”„ åŒæ­¥ç‰ˆæœ¬å·åˆ° Android åº”ç”¨é…ç½®
        id: sync-android-version
        run: |
          CORE_VERSION="${{ needs.version-release.outputs.core_version }}"
          echo "åŒæ­¥ç‰ˆæœ¬å·: $CORE_VERSION"
          
          # æ›´æ–° tauri.conf.json ä¸­çš„ç‰ˆæœ¬å·
          configPath="packages/web/src-tauri/tauri.conf.json"
          jq --arg version "$CORE_VERSION" '.version = $version' "$configPath" > tmp.json && mv tmp.json "$configPath"
          
          # æ›´æ–° Cargo.toml ä¸­çš„ç‰ˆæœ¬å·
          cargoPath="packages/web/src-tauri/Cargo.toml"
          sed -i "s/^version = \".*\"/version = \"$CORE_VERSION\"/" "$cargoPath"
          
          echo "android_version=$CORE_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Android ç‰ˆæœ¬å·å·²åŒæ­¥ä¸º: $CORE_VERSION"

      - name: ðŸ“± æž„å»º Android APK (aarch64)
        id: android-build
        run: |
          echo "å¼€å§‹æž„å»º Android APK (aarch64 æž¶æž„)..."
          
          cd packages/web
          
          # æž„å»ºAndroid APKï¼Œå¦‚æžœå¤±è´¥ç«‹å³é€€å‡º
          if pnpm build:android; then
            echo "success=true" >> $GITHUB_OUTPUT
            
            # æŸ¥æ‰¾æž„å»ºäº§ç‰©
            APK_PATH=$(find src-tauri/gen/android -name "*.apk" | head -1)
            
            if [ -n "$APK_PATH" ]; then
              APK_NAME=$(basename "$APK_PATH")
              echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
              echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
              echo "æ‰¾åˆ° APK æ–‡ä»¶: $APK_PATH"
              echo "æ–‡ä»¶å: $APK_NAME"
            else
              echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1  # ç«‹å³ç»ˆæ­¢
            fi
          else
            echo "âŒ Android APK æž„å»ºå¤±è´¥"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1  # ç«‹å³ç»ˆæ­¢
          fi

      - name: ðŸ“¤ ä¸Šä¼  Android APK æž„å»ºäº§ç‰©
        if: steps.android-build.outputs.success == 'true'
        id: upload-android-artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.android-build.outputs.apk_name }}
          path: packages/web/${{ steps.android-build.outputs.apk_path }}
          retention-days: 30
          compression-level: 0

      - name: ðŸš€ ä¸Šä¼  APK åˆ° Release
        if: |
          steps.android-build.outputs.success == 'true' && 
          needs.version-release.outputs.should_upload_release == 'true' && 
          needs.version-release.outputs.release_tag_name != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version-release.outputs.release_tag_name }}
          files: packages/web/${{ steps.android-build.outputs.apk_path }}
          name: ${{ steps.android-build.outputs.apk_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š ç”Ÿæˆ Android åº”ç”¨ä¿¡æ¯
        if: steps.android-build.outputs.success == 'true'
        id: android-summary
        run: |
          ARTIFACT_ID="${{ steps.upload-android-artifact.outputs.artifact-id }}"
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/$ARTIFACT_ID"
          echo "artifact_url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
          
          echo "## ðŸ“± Android APK æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± åº”ç”¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°:** Android (aarch64)" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶å:** \`${{ steps.android-build.outputs.apk_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`${{ steps.sync-android-version.outputs.android_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸºäºŽCoreç‰ˆæœ¬:** \`${{ needs.version-release.outputs.core_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **ç›´æŽ¥ä¸‹è½½:** [ç‚¹å‡»ä¸‹è½½ ${{ steps.android-build.outputs.apk_name }}]($ARTIFACT_URL)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.version-release.outputs.should_upload_release }}" = "true" ] && [ "${{ needs.version-release.outputs.release_tag_name }}" != "" ]; then
            echo "- ðŸš€ **Releaseä¸‹è½½:** [ç‚¹å‡»è¿™é‡Œä¸‹è½½æœ€æ–°ç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/tag/${{ needs.version-release.outputs.release_tag_name }})" >> $GITHUB_STEP_SUMMARY
          fi

  # æ¡Œé¢åº”ç”¨æž„å»ºå®ŒæˆåŽç«‹å³æ›´æ–°è¯„è®º
  update-pr-comment-desktop:
    runs-on: ubuntu-latest
    needs: [unified-build, preview-package-publish, desktop-build]
    if: github.event_name == 'pull_request' && always() && needs.desktop-build.result != 'skipped'
    steps:
      - name: ðŸ’¬ æ›´æ–°æ¡Œé¢åº”ç”¨æž„å»ºçŠ¶æ€
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## ðŸ“¦ é¢„è§ˆåŒ…å‘å¸ƒæˆåŠŸ
            
            ### ðŸ·ï¸ åŒ…ä¿¡æ¯
            - **ç‰ˆæœ¬:** `${{ needs.preview-package-publish.outputs.pkg_version }}`
            - **æäº¤:** [`${{ needs.unified-build.outputs.short_commit_hash }}`](https://github.com/${{ github.repository }}/tree/${{ needs.unified-build.outputs.commit_hash }})
            
            ### ðŸ“¥ å®‰è£…å‘½ä»¤
            ```bash
            ${{ needs.preview-package-publish.outputs.pnpm_install_cmd }}
            ```
            
            ### ðŸ–¥ï¸ Windows æ¡Œé¢åº”ç”¨
            ${{ needs.desktop-build.result == 'success' && '- **çŠ¶æ€:** âœ… æž„å»ºæˆåŠŸ' || '- **çŠ¶æ€:** âŒ æž„å»ºå¤±è´¥' }}
            ${{ needs.desktop-build.result == 'success' && format('- **ç‰ˆæœ¬:** `{0}`', needs.desktop-build.outputs.desktop_version) || '' }}
            ${{ needs.desktop-build.result == 'success' && format('- **ä¸‹è½½:** [ç‚¹å‡»ä¸‹è½½]({0})', needs.desktop-build.outputs.desktop_artifact_url) || '' }}
            
            ### ðŸ“± Android åº”ç”¨
            - **çŠ¶æ€:** ðŸ”„ æž„å»ºä¸­...
            - **æž¶æž„:** aarch64
            
            ---
            > ðŸ’¡ Android åº”ç”¨æž„å»ºå®ŒæˆåŽå°†è‡ªåŠ¨æ›´æ–°æ­¤è¯„è®º
          comment-tag: published-packages
          mode: upsert
          reactions: rocket

  # Androidåº”ç”¨æž„å»ºå®ŒæˆåŽæ›´æ–°è¯„è®º
  update-pr-comment-android:
    runs-on: ubuntu-latest
    needs: [unified-build, preview-package-publish, desktop-build, android-build]
    if: github.event_name == 'pull_request' && always() && needs.android-build.result != 'skipped'
    steps:
      - name: ðŸ’¬ æ›´æ–°æœ€ç»ˆæž„å»ºçŠ¶æ€
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## ðŸ“¦ é¢„è§ˆåŒ…å‘å¸ƒæˆåŠŸ
            
            ### ðŸ·ï¸ åŒ…ä¿¡æ¯
            - **ç‰ˆæœ¬:** `${{ needs.preview-package-publish.outputs.pkg_version }}`
            - **æäº¤:** [`${{ needs.unified-build.outputs.short_commit_hash }}`](https://github.com/${{ github.repository }}/tree/${{ needs.unified-build.outputs.commit_hash }})
            
            ### ðŸ“¥ å®‰è£…å‘½ä»¤
            ```bash
            ${{ needs.preview-package-publish.outputs.pnpm_install_cmd }}
            ```
            
            ### ðŸ–¥ï¸ Windows æ¡Œé¢åº”ç”¨
            ${{ needs.desktop-build.result == 'success' && '- **çŠ¶æ€:** âœ… æž„å»ºæˆåŠŸ' || (needs.desktop-build.result == 'skipped' && '- **çŠ¶æ€:** â­ï¸ å·²è·³è¿‡æž„å»º' || '- **çŠ¶æ€:** âŒ æž„å»ºå¤±è´¥') }}
            ${{ needs.desktop-build.result == 'success' && format('- **ç‰ˆæœ¬:** `{0}`', needs.desktop-build.outputs.desktop_version) || '' }}
            ${{ needs.desktop-build.result == 'success' && format('- **ä¸‹è½½:** [ç‚¹å‡»ä¸‹è½½]({0})', needs.desktop-build.outputs.desktop_artifact_url) || '' }}
            
            ### ðŸ“± Android åº”ç”¨
            ${{ needs.android-build.result == 'success' && '- **çŠ¶æ€:** âœ… æž„å»ºæˆåŠŸ' || '- **çŠ¶æ€:** âŒ æž„å»ºå¤±è´¥' }}
            ${{ needs.android-build.result == 'success' && format('- **ç‰ˆæœ¬:** `{0}`', needs.android-build.outputs.android_version) || '' }}
            ${{ needs.android-build.result == 'success' && format('- **æž¶æž„:** aarch64') || '' }}
            ${{ needs.android-build.result == 'success' && format('- **ä¸‹è½½:** [ç‚¹å‡»ä¸‹è½½]({0})', needs.android-build.outputs.android_artifact_url) || '' }}
            
            ---
          comment-tag: published-packages
          mode: upsert
          reactions: rocket, hooray

  build-summary:
    runs-on: ubuntu-latest
    needs: [unified-build, preview-package-publish, desktop-build, android-build]
    if: always() && needs.unified-build.outputs.build_success == 'true'
    steps:
      - name: ðŸ“Š ç”Ÿæˆå®Œæ•´æž„å»ºæ‘˜è¦
        run: |
          echo "# ðŸš€ æž„å»ºå®Œæˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # NPM åŒ…ä¿¡æ¯
          if [ "${{ needs.preview-package-publish.result }}" = "success" ]; then
            echo "## ðŸ“¦ NPM é¢„è§ˆåŒ…" >> $GITHUB_STEP_SUMMARY
            echo "- **ç‰ˆæœ¬:** \`${{ needs.preview-package-publish.outputs.pkg_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **å®‰è£…å‘½ä»¤:** \`${{ needs.preview-package-publish.outputs.pnpm_install_cmd }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ¡Œé¢åº”ç”¨ä¿¡æ¯
          if [ "${{ needs.desktop-build.result }}" = "success" ]; then
            echo "## ðŸ–¥ï¸ Windows æ¡Œé¢åº”ç”¨" >> $GITHUB_STEP_SUMMARY
            echo "- **çŠ¶æ€:** âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- **ç‰ˆæœ¬:** \`${{ needs.desktop-build.outputs.desktop_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **ä¸‹è½½:** [ç‚¹å‡»ä¸‹è½½](${{ needs.desktop-build.outputs.desktop_artifact_url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.desktop-build.result }}" = "failure" ]; then
            echo "## ðŸ–¥ï¸ Windows æ¡Œé¢åº”ç”¨" >> $GITHUB_STEP_SUMMARY
            echo "- **çŠ¶æ€:** âŒ æž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Android åº”ç”¨ä¿¡æ¯
          if [ "${{ needs.android-build.result }}" = "success" ]; then
            echo "## ðŸ“± Android åº”ç”¨" >> $GITHUB_STEP_SUMMARY
            echo "- **çŠ¶æ€:** âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- **ç‰ˆæœ¬:** \`${{ needs.android-build.outputs.android_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **æž¶æž„:** aarch64" >> $GITHUB_STEP_SUMMARY
            echo "- **ä¸‹è½½:** [ç‚¹å‡»ä¸‹è½½](${{ needs.android-build.outputs.android_artifact_url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.android-build.result }}" = "failure" ]; then
            echo "## ðŸ“± Android åº”ç”¨" >> $GITHUB_STEP_SUMMARY
            echo "- **çŠ¶æ€:** âŒ æž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi