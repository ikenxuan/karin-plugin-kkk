name: CI/CD

on:
  workflow_dispatch:
    inputs:
      # æ‰‹åŠ¨è¿è¡Œæ¨¡å¼é€‰æ‹©
      run_mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      
      # æ‰‹åŠ¨å‘å¸ƒç‰ˆæœ¬å·ï¼ˆä»…ç”Ÿäº§æ¨¡å¼éœ€è¦ï¼‰
      manual_version:
        description: 'æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å· (å¦‚: 1.2.3ï¼Œä»…ç”Ÿäº§æ¨¡å¼æœ‰æ•ˆ)'
        required: false
        type: string
      
      # å‘å¸ƒè¯´æ˜
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜ (å¯é€‰)'
        required: false
        type: string
      
      # æ˜¯å¦å¼ºåˆ¶å‘å¸ƒåˆ° NPM
      force_npm_publish:
        description: 'å¼ºåˆ¶å‘å¸ƒåˆ° NPM (ä»…ç”Ÿäº§æ¨¡å¼)'
        required: false
        default: false
        type: boolean

  push:
    branches:
      - main
    paths-ignore:
      - 'packages/docs/**'
  pull_request:
    types: [opened, reopened, synchronize]
    paths-ignore:
      - 'packages/docs/**'

env:
  APP_NAME: karin-plugin-kkk

permissions:
  contents: write
  id-token: write
  packages: write
  pull-requests: write

jobs:
  # ç‰ˆæœ¬å‘å¸ƒç®¡ç†
  version-release:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release-please.outputs.releases_created || steps.manual-release.outputs.releases_created }}
      core_release_created: ${{ steps.release-please.outputs['packages/core--release_created'] || steps.manual-release.outputs.core_release_created }}
      core_tag_name: ${{ steps.release-please.outputs['packages/core--tag_name'] || steps.manual-release.outputs.core_tag_name }}
      core_version: ${{ steps.get-version-info.outputs.core_version }}
      should_upload_release: ${{ steps.get-version-info.outputs.should_upload_release }}
      release_tag_name: ${{ steps.get-version-info.outputs.release_tag_name }}
      is_manual_production: ${{ steps.get-version-info.outputs.is_manual_production }}
      manual_release_notes: ${{ steps.get-version-info.outputs.manual_release_notes }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # è‡ªåŠ¨ç‰ˆæœ¬å‘å¸ƒæ£€æŸ¥ï¼ˆéæ‰‹åŠ¨ç”Ÿäº§æ¨¡å¼ï¼‰
      - name: ğŸš€ æ‰§è¡Œç‰ˆæœ¬å‘å¸ƒæ£€æŸ¥
        if: github.event_name != 'workflow_dispatch' || inputs.run_mode != 'production'
        id: release-please
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

      # æ‰‹åŠ¨ç”Ÿäº§å‘å¸ƒå¤„ç†
      - name: ğŸ¯ å¤„ç†æ‰‹åŠ¨ç”Ÿäº§å‘å¸ƒ
        if: github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production'
        id: manual-release
        run: |
          if [ -z "${{ inputs.manual_version }}" ]; then
            echo "âŒ ç”Ÿäº§æ¨¡å¼å¿…é¡»æŒ‡å®šç‰ˆæœ¬å·" >&2
            exit 1
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if ! echo "${{ inputs.manual_version }}" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º x.y.z æ ¼å¼" >&2
            exit 1
          fi
          
          echo "releases_created=true" >> $GITHUB_OUTPUT
          echo "core_release_created=true" >> $GITHUB_OUTPUT
          echo "core_tag_name=v${{ inputs.manual_version }}" >> $GITHUB_OUTPUT
          
          echo "âœ… æ‰‹åŠ¨ç”Ÿäº§å‘å¸ƒå·²é…ç½®ï¼šv${{ inputs.manual_version }}"

      - name: ğŸ·ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: get-version-info
        run: |
          cd packages/core
          
          # å¤„ç†æ‰‹åŠ¨ç”Ÿäº§æ¨¡å¼
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.run_mode }}" = "production" ]; then
            # æ‰‹åŠ¨æ›´æ–° package.json ç‰ˆæœ¬å·
            npm version ${{ inputs.manual_version }} --no-git-tag-version
            CORE_VERSION="${{ inputs.manual_version }}"
            echo "should_upload_release=true" >> $GITHUB_OUTPUT
            echo "release_tag_name=v${{ inputs.manual_version }}" >> $GITHUB_OUTPUT
            echo "is_manual_production=true" >> $GITHUB_OUTPUT
            echo "manual_release_notes=${{ inputs.release_notes }}" >> $GITHUB_OUTPUT
            echo "ğŸ¯ æ‰‹åŠ¨ç”Ÿäº§æ¨¡å¼ï¼šç‰ˆæœ¬ $CORE_VERSION"
          else
            # è‡ªåŠ¨æ¨¡å¼æˆ–é¢„è§ˆæ¨¡å¼
            CORE_VERSION=$(node -p "require('./package.json').version")
            echo "is_manual_production=false" >> $GITHUB_OUTPUT
            echo "manual_release_notes=" >> $GITHUB_OUTPUT
            
            if [ "${{ steps.release-please.outputs.core_release_created }}" = "true" ] || [ "${{ inputs.force_npm_publish }}" = "true" ]; then
              echo "should_upload_release=true" >> $GITHUB_OUTPUT
              echo "release_tag_name=${{ steps.release-please.outputs.core_tag_name }}" >> $GITHUB_OUTPUT
            else
              echo "should_upload_release=false" >> $GITHUB_OUTPUT
              echo "release_tag_name=" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "core_version=$CORE_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ å½“å‰ç‰ˆæœ¬ï¼š$CORE_VERSION"

  # ç»Ÿä¸€æ„å»ºä½œä¸šï¼ˆä»…æ ¸å¿ƒåŒ…å’ŒWebåº”ç”¨ï¼‰
  unified-build:
    runs-on: ubuntu-latest
    needs: [version-release]
    outputs:
      build_success: ${{ steps.build-status.outputs.success }}
      package_name: ${{ steps.package-info.outputs.name }}
      package_short_name: ${{ steps.package-info.outputs.short_name }}
      commit_hash: ${{ steps.git-info.outputs.commit_hash }}
      short_commit_hash: ${{ steps.git-info.outputs.short_commit_hash }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ğŸ“¦ é…ç½® PNPM ç¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: ğŸŸ¢ é…ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ğŸ”¨ æ‰§è¡Œå®Œæ•´é¡¹ç›®æ„å»º
        run: |
          echo "å¼€å§‹æ„å»ºæ‰€æœ‰åŒ…..."
          pnpm build:core
          if [ $? -ne 0 ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œé€€å‡ºå·¥ä½œæµ"
            exit 1
          fi
          echo "âœ… æ„å»ºæˆåŠŸ"

      - name: ğŸ·ï¸ è·å–åŒ…ä¿¡æ¯
        id: package-info
        working-directory: packages/core
        run: |
          PACKAGE_NAME=$(pnpm pkg get name | tr -d '"')
          PACKAGE_SHORT_NAME=$(basename "$PACKAGE_NAME")
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "short_name=$PACKAGE_SHORT_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ“Š è·å– Git ä¿¡æ¯
        id: git-info
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "short_commit_hash=$SHORT_COMMIT_HASH" >> $GITHUB_OUTPUT

      # æ‰‹åŠ¨ç”Ÿäº§æ¨¡å¼ï¼šåº”ç”¨ç‰ˆæœ¬å·å˜æ›´
      - name: ğŸ¯ åº”ç”¨æ‰‹åŠ¨ç‰ˆæœ¬å·
        if: github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production'
        run: |
          cd packages/core
          npm version ${{ inputs.manual_version }} --no-git-tag-version
          echo "âœ… å·²åº”ç”¨æ‰‹åŠ¨ç‰ˆæœ¬å·ï¼š${{ inputs.manual_version }}"

      - name: ğŸ“¦ å‡†å¤‡å‘å¸ƒäº§ç‰© (æ­£å¼ç‰ˆ)
        if: needs.version-release.outputs.core_release_created == 'true' || (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production')
        run: |
          cd packages/core
          pnpm pkg delete devDependencies
          mkdir -p ${{ runner.temp }}/production/
          cp -r package.json README.md CHANGELOG.md LICENSE config resources lib ${{ runner.temp }}/production/

      - name: ğŸ“¦ å‡†å¤‡æ„å»ºåˆ†æ”¯äº§ç‰©
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cd packages/core
          pnpm pkg delete devDependencies
          mkdir -p ${{ runner.temp }}/build-branch/
          cp -r package.json CHANGELOG.md README.md LICENSE resources config lib ${{ runner.temp }}/build-branch/

      - name: ğŸ“¦ å‡†å¤‡é¢„è§ˆåŒ…äº§ç‰©
        if: github.event_name != 'workflow_dispatch' || inputs.run_mode != 'production'
        run: |
          cd packages/core
          mkdir -p ${{ runner.temp }}/preview/
          cp -r package.json README.md CHANGELOG.md LICENSE config resources lib ${{ runner.temp }}/preview/

      - name: ğŸ“¤ ä¸Šä¼ æ­£å¼ç‰ˆæ„å»ºäº§ç‰©
        if: needs.version-release.outputs.core_release_created == 'true' || (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production')
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: ${{ runner.temp }}/production/

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºåˆ†æ”¯äº§ç‰©
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: build-branch-artifacts
          path: ${{ runner.temp }}/build-branch/

      - name: ğŸ“¤ ä¸Šä¼ é¢„è§ˆåŒ…äº§ç‰©
        if: github.event_name != 'workflow_dispatch' || inputs.run_mode != 'production'
        uses: actions/upload-artifact@v4
        with:
          name: preview-build
          path: ${{ runner.temp }}/preview/

      - name: âœ… æ ‡è®°æ„å»ºçŠ¶æ€
        id: build-status
        run: echo "success=true" >> $GITHUB_OUTPUT

  # NPM æ­£å¼å‘å¸ƒ
  npm-production-publish:
    runs-on: ubuntu-latest
    needs: [version-release, unified-build]
    if: |
      needs.unified-build.outputs.build_success == 'true' && (
        needs.version-release.outputs.core_release_created == 'true' ||
        (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production') ||
        inputs.force_npm_publish == true
      )
    permissions:
      contents: write
      id-token: write
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: packages/core

      - name: ğŸŸ¢ é…ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'

      - uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: â« å‡çº§ npm ç‰ˆæœ¬
        run: npm install -g npm@latest

      - name: ğŸš€ å‘å¸ƒåˆ° NPM å®˜æ–¹æº
        id: publish-to-npm
        working-directory: packages/core
        run: |
          pnpm publish --no-git-checks --provenance
          
          echo "name=$(npm pkg get name | tr -d '"')" >> $GITHUB_OUTPUT
          echo "version=$(npm pkg get version | tr -d '"')" >> $GITHUB_OUTPUT

      - name: ğŸ“Š ç”Ÿæˆå‘å¸ƒæŠ¥å‘Š
        run: |
          echo "## ğŸ“¦ NPM å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒ…å:** \`${{ steps.publish-to-npm.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`${{ steps.publish-to-npm.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¨¡å¼:** ${{ github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production' && 'ğŸ¯ æ‰‹åŠ¨ç”Ÿäº§å‘å¸ƒ' || 'ğŸ¤– è‡ªåŠ¨å‘å¸ƒ' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.version-release.outputs.manual_release_notes }}" != "" ]; then
            echo "- **å‘å¸ƒè¯´æ˜:** ${{ needs.version-release.outputs.manual_release_notes }}" >> $GITHUB_STEP_SUMMARY
          fi

  # GitHub Packages å‘å¸ƒ
  github-package-publish:
    runs-on: ubuntu-latest
    needs: [version-release, unified-build]
    permissions:
      contents: read
      packages: write
    if: |
      needs.unified-build.outputs.build_success == 'true' && (
        needs.version-release.outputs.core_release_created == 'true' ||
        (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'production') ||
        inputs.force_npm_publish == true
      )
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: packages/core

      - name: ğŸŸ¢ é…ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://npm.pkg.github.com'

      - name: âœï¸ ä¿®æ”¹åŒ…å (æ·»åŠ  Scope)
        working-directory: packages/core
        run: |
          # è¯»å–åŸå§‹åŒ…å
          ORIGINAL_NAME=$(node -p "require('./package.json').name")
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          # æ„é€ æ–°åŒ…å @owner/name
          NEW_NAME="@$OWNER/$ORIGINAL_NAME"
          
          echo "ğŸ“¦ ä¿®æ”¹åŒ…å: $ORIGINAL_NAME -> $NEW_NAME"
          
          # ä¿®æ”¹ package.json
          node -e "
            const fs = require('fs');
            const pkg = require('./package.json');
            pkg.name = '$NEW_NAME';
            pkg.publishConfig = { registry: 'https://npm.pkg.github.com/' };
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

      - name: ğŸš€ å‘å¸ƒåˆ° GitHub Packages
        working-directory: packages/core
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š ç”Ÿæˆå‘å¸ƒæŠ¥å‘Š
        run: |
          echo "## ğŸ“¦ GitHub Packages å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          PKG_NAME=$(node -p "require('./packages/core/package.json').name")
          VERSION=$(node -p "require('./packages/core/package.json').version")
          
          echo "- **åŒ…å:** \`$PKG_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¥ å®‰è£…é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨ \`.npmrc\` ä¸­æ·»åŠ ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`ini" >> $GITHUB_STEP_SUMMARY
          echo "@${{ github.repository_owner }}:registry=https://npm.pkg.github.com" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "ç„¶åè¿è¡Œï¼š" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install $PKG_NAME" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # é•œåƒæºåŒæ­¥
  npm-mirror-sync:
    runs-on: ubuntu-latest
    needs: [npm-production-publish]
    steps:
      - name: ğŸ”„ åŒæ­¥åˆ°å›½å†…é•œåƒæº
        run: |
          curl -X PUT "https://registry-direct.npmmirror.com/-/package/karin-plugin-kkk/syncs"

  # æ„å»ºåˆ†æ”¯åŒæ­¥
  build-branch-sync:
    runs-on: ubuntu-latest
    needs: [unified-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.unified-build.outputs.build_success == 'true'
    outputs:
      build_completed: ${{ steps.build-success.outputs.completed }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-branch-artifacts
          path: ${{ runner.temp }}/build-artifacts/
      
      - name: âœ… æ ‡è®°æ„å»ºå®Œæˆ
        id: build-success
        run: echo "completed=true" >> $GITHUB_OUTPUT
      
      - name: âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ”„ åŒæ­¥ä¸»åˆ†æ”¯æœ€æ–°ä»£ç 
        run: |
          git fetch origin ${{ github.ref_name }}
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }} --ff-only

      - name: ğŸ” æ£€æŸ¥æ„å»ºåˆ†æ”¯çŠ¶æ€
        id: check-branch
        run: |
          if git ls-remote --exit-code origin build; then
            echo "branch_exists=true" >> $GITHUB_ENV
          else
            echo "branch_exists=false" >> $GITHUB_ENV
          fi

      - name: ğŸŒ¿ åˆå§‹åŒ–æ„å»ºåˆ†æ”¯
        run: |          
          if [ "${{ env.branch_exists }}" = "false" ]; then
            git checkout --orphan build
            git reset --hard
            git clean -fd
            git commit --allow-empty -m "åˆå§‹åŒ–ç¼–è¯‘åˆ†æ”¯"
            git push --set-upstream -f origin build
          else
            git fetch origin build
            git reset --hard
            git clean -fd
            git reset --hard origin/build
            git checkout build
          fi

      - name: ğŸ—‚ï¸ å‡†å¤‡æ„å»ºæ–‡ä»¶
        run: |
          find . -mindepth 1 -maxdepth 1 -not -name '.git' -exec rm -rf {} \;
          cp -rv ${{ runner.temp }}/build-artifacts/* ./

      - name: ğŸ’¾ æäº¤æ„å»ºç»“æœ
        run: |
          git add .
          if [ -z "$(git diff --cached --name-only)" ]; then
            echo "No changes detected"
            exit 0
          else
            git commit -m "chore(build): æ„å»ºåˆ†æ”¯åŒæ­¥"
          fi

      - name: ğŸš€ æ¨é€åˆ°æ„å»ºåˆ†æ”¯
        uses: ad-m/github-push-action@master
        with:
          branch: build
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force_with_lease: true

  # é¢„è§ˆåŒ…å‘å¸ƒï¼ˆä¼˜å…ˆæ‰§è¡Œï¼‰
  preview-package-publish:
    runs-on: ubuntu-latest
    needs: [unified-build, version-release]
    if: needs.unified-build.outputs.build_success == 'true' && (github.event_name != 'workflow_dispatch' || inputs.run_mode != 'production')
    outputs:
      pkg_version: ${{ steps.version-gen.outputs.version }}
      pnpm_install_cmd: ${{ steps.publish_pkg.outputs.pnpm_install_cmd }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ğŸ“¦ é…ç½® PNPM ç¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: ğŸŸ¢ é…ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: preview-build
          path: packages/core

      - name: ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡è¯†
        id: version-gen
        working-directory: packages/core
        run: |
          # 1) è·å–æœ€æ–°çš„Gitæ ‡ç­¾ç‰ˆæœ¬ä½œä¸ºåŸºå‡†
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            # ç§»é™¤vå‰ç¼€å¹¶æå–ç‰ˆæœ¬å·
            LAST_TAG_VERSION=${LAST_TAG#v}
            if echo "$LAST_TAG_VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' >/dev/null; then
              BASE_VERSION="$LAST_TAG_VERSION"
            else
              BASE_VERSION="0.0.0"
            fi
          else
            BASE_VERSION="0.0.0"
          fi

          # 2) è·å–release-pleaseè¾“å‡ºçš„ç‰ˆæœ¬ä½œä¸ºå‚è€ƒ
          RELEASE_VERSION="${{ needs.version-release.outputs.core_version }}"
          PKG_VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "")
          
          # 3) é€‰æ‹©æœ€é«˜çš„ç‰ˆæœ¬ä½œä¸ºåŸºå‡†ï¼ˆç¡®ä¿ä¸ä¼šå€’é€€ï¼‰
          compare_versions() {
            local v1=$1 v2=$2
            local IFS=.
            local i ver1=($v1) ver2=($v2)
            for ((i=0; i<3; i++)); do
              if [[ ${ver1[i]:-0} -gt ${ver2[i]:-0} ]]; then
                return 1  # v1 > v2
              elif [[ ${ver1[i]:-0} -lt ${ver2[i]:-0} ]]; then
                return 2  # v1 < v2
              fi
            done
            return 0  # v1 == v2
          }
          
          # é€‰æ‹©æœ€é«˜ç‰ˆæœ¬ä½œä¸ºåŸºå‡†
          FINAL_BASE="$BASE_VERSION"
          if [ -n "$RELEASE_VERSION" ] && echo "$RELEASE_VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' >/dev/null; then
            compare_versions "$FINAL_BASE" "$RELEASE_VERSION"
            case $? in
              2) FINAL_BASE="$RELEASE_VERSION" ;;  # RELEASE_VERSIONæ›´é«˜
            esac
          fi
          if [ -n "$PKG_VERSION" ] && echo "$PKG_VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' >/dev/null; then
            compare_versions "$FINAL_BASE" "$PKG_VERSION"
            case $? in
              2) FINAL_BASE="$PKG_VERSION" ;;  # PKG_VERSIONæ›´é«˜
            esac
          fi
          
          echo "ğŸ·ï¸ åŸºå‡†ç‰ˆæœ¬é€‰æ‹©ï¼š"
          echo "  - Gitæ ‡ç­¾ç‰ˆæœ¬: $BASE_VERSION"
          echo "  - Releaseç‰ˆæœ¬: $RELEASE_VERSION"
          echo "  - Packageç‰ˆæœ¬: $PKG_VERSION"
          echo "  - æœ€ç»ˆåŸºå‡†: $FINAL_BASE"

          # 4) åŸºäºæäº¤ä¿¡æ¯åˆ¤æ–­ç‰ˆæœ¬æå‡ç±»å‹
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            COMMITS=$(git log --no-merges --pretty=%s HEAD ^origin/main 2>/dev/null || echo "")
          else
            if [ -n "$LAST_TAG" ]; then
              COMMITS=$(git log --no-merges --pretty=%s "$LAST_TAG"..HEAD 2>/dev/null || echo "")
            else
              COMMITS=$(git log --no-merges --pretty=%s HEAD 2>/dev/null || echo "")
            fi
          fi

          echo "ğŸ“ åˆ†ææäº¤ä¿¡æ¯ï¼š"
          echo "$COMMITS" | head -5

          BUMP="none"
          # BREAKING CHANGE -> major
          if echo "$COMMITS" | grep -E 'BREAKING CHANGE|^.*!:' >/dev/null; then
            BUMP="major"
          # feat -> minor
          elif echo "$COMMITS" | grep -E '^feat(\(.+\))?:' >/dev/null; then
            BUMP="minor"
          # fix, perf, refactor -> patch
          elif echo "$COMMITS" | grep -E '^(fix|perf|refactor)(\(.+\))?:' >/dev/null; then
            BUMP="patch"
          fi

          echo "ğŸ”„ ç‰ˆæœ¬æå‡ç±»å‹: $BUMP"

          # 5) è®¡ç®—æ–°ç‰ˆæœ¬å·
          MAJOR=$(echo "$FINAL_BASE" | cut -d. -f1)
          MINOR=$(echo "$FINAL_BASE" | cut -d. -f2)
          PATCH=$(echo "$FINAL_BASE" | cut -d. -f3)
          [ -z "$MAJOR" ] && MAJOR=0
          [ -z "$MINOR" ] && MINOR=0
          [ -z "$PATCH" ] && PATCH=0

          case "$BUMP" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
            *) 
              # å¦‚æœæ²¡æœ‰åŒ¹é…çš„æäº¤ç±»å‹ï¼Œè‡³å°‘æå‡patchç‰ˆæœ¬ï¼ˆé¿å…ç‰ˆæœ¬å€’é€€ï¼‰
              PATCH=$((PATCH + 1))
              ;;
          esac
          BASE_NEXT="${MAJOR}.${MINOR}.${PATCH}"

          echo "ğŸ“¦ è®¡ç®—åçš„åŸºç¡€ç‰ˆæœ¬: $BASE_NEXT"

          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo 0)
          TIMESTAMP=$(date +%s)

          # 6) æ ¹æ®äº‹ä»¶ç±»å‹æ‹¼æ¥é¢„å‘å¸ƒåç¼€
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if [[ "${{ github.head_ref }}" == release-please--branches--* ]]; then
              TAG="${{ needs.version-release.outputs.release_tag_name }}"
              if [ -n "$TAG" ]; then
                TAG=${TAG#v}
                BASE_NEXT="$TAG"
              fi
              TIME_SUFFIX=$(TZ='Asia/Shanghai' date +%m%d%H%M)
              NEW_VERSION="${BASE_NEXT}-rc.${TIME_SUFFIX}"
            else
              PR_NUMBER=${{ github.event.number }}
              PR_COMMIT_COUNT=$(git rev-list --count HEAD ^origin/main 2>/dev/null || echo 0)
              NEW_VERSION="${BASE_NEXT}-alpha.${PR_NUMBER}.${PR_COMMIT_COUNT}"
            fi
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            TIME_SUFFIX=$(echo "$TIMESTAMP" | tail -c 5)
            NEW_VERSION="${BASE_NEXT}-beta.${COMMIT_COUNT}.${TIME_SUFFIX}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TIME_SUFFIX=$(TZ='Asia/Shanghai' date +%m%d%H%M)
            NEW_VERSION="${BASE_NEXT}-manual.${TIME_SUFFIX}"
          else
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
            NEW_VERSION="${BASE_NEXT}-dev.${BRANCH_NAME}.${{ needs.unified-build.outputs.short_commit_hash }}"
          fi

          echo "ğŸ¯ æœ€ç»ˆç”Ÿæˆç‰ˆæœ¬: $NEW_VERSION"
          npm version "$NEW_VERSION" --no-git-tag-version
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ§¹ æ¸…ç†å¼€å‘ä¾èµ–
        working-directory: packages/core
        run: pnpm pkg delete devDependencies

      - name: ğŸš€ å‘å¸ƒé¢„è§ˆåŒ…
        id: publish_pkg
        working-directory: packages/core
        run: |
          pnpm install --no-frozen-lockfile
          npx --yes pkg-pr-new publish --json output.json --comment=off --compact --packageManager=pnpm > pkg-output.txt 2>&1
          
          ACTUAL_INSTALL_URL=$(grep -oE 'https://pkg\.pr\.new/[^[:space:]`]+' pkg-output.txt | head -n 1 || echo "")
          
          if [ ! -z "$ACTUAL_INSTALL_URL" ]; then
            # å°è¯•æå–çŸ­é“¾æ¥æ ¼å¼ (package@sha)
            if [[ "$ACTUAL_INSTALL_URL" =~ https://pkg\.pr\.new/[^/]+/[^/]+/([^/]+@.+) ]]; then
              ACTUAL_INSTALL_URL="https://pkg.pr.new/${BASH_REMATCH[1]}"
            fi
            PNPM_INSTALL_CMD="pnpm add ${ACTUAL_INSTALL_URL} -w"
          else
            PNPM_INSTALL_CMD="æœªæ‰¾åˆ°å®‰è£…å‘½ä»¤"
          fi
          
          echo "pnpm_install_cmd=$PNPM_INSTALL_CMD" >> $GITHUB_OUTPUT

      - name: ğŸ’¬ å‘å¸ƒ PR è¯„è®º
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## ğŸ“¦ é¢„è§ˆåŒ…å‘å¸ƒæˆåŠŸ
            
            ### ğŸ·ï¸ åŒ…ä¿¡æ¯
            - **ç‰ˆæœ¬:** `${{ steps.version-gen.outputs.version }}`
            - **æäº¤:** [`${{ needs.unified-build.outputs.short_commit_hash }}`](https://github.com/${{ github.repository }}/tree/${{ needs.unified-build.outputs.commit_hash }})
            
            ### ğŸ“¥ å®‰è£…å‘½ä»¤
            ```bash
            ${{ steps.publish_pkg.outputs.pnpm_install_cmd }}
            ```
          comment-tag: published-packages
          mode: upsert
          reactions: rocket

  # é¢„è§ˆåŒ…å‘å¸ƒåçš„å³æ—¶æ„å»ºæ‘˜è¦ï¼ˆPRï¼‰
  pr-summary:
    runs-on: ubuntu-latest
    needs: [unified-build, preview-package-publish]
    if: github.event_name == 'pull_request' && needs.unified-build.outputs.build_success == 'true' && needs.preview-package-publish.result == 'success'
    steps:
      - name: ğŸ“Š ç”ŸæˆPRæ„å»ºæ‘˜è¦
        run: |
          echo "# ğŸš€ PR æ„å»ºå®Œæˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“¦ NPM é¢„è§ˆåŒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`${{ needs.preview-package-publish.outputs.pkg_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“¥ å®‰è£…å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.preview-package-publish.outputs.pnpm_install_cmd }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # é¢„è§ˆåŒ…å‘å¸ƒåçš„å³æ—¶æ„å»ºæ‘˜è¦ï¼ˆä»…é’ˆå¯¹mainåˆ†æ”¯æ¨é€ï¼‰
  main-push-summary:
    runs-on: ubuntu-latest
    needs: [unified-build, preview-package-publish]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.unified-build.outputs.build_success == 'true' && needs.preview-package-publish.result == 'success'
    steps:
      - name: ğŸ“Š ç”Ÿæˆmainåˆ†æ”¯æ¨é€æ„å»ºæ‘˜è¦
        run: |
          echo "# ğŸš€ Mainåˆ†æ”¯æ„å»ºå®Œæˆæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # NPM é¢„è§ˆåŒ…ä¿¡æ¯
          echo "## ğŸ“¦ NPM é¢„è§ˆåŒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`${{ needs.preview-package-publish.outputs.pkg_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¥ å®‰è£…å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.preview-package-publish.outputs.pnpm_install_cmd }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ„å»ºä¿¡æ¯
          echo "## â„¹ï¸ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤:** [\`${{ needs.unified-build.outputs.short_commit_hash }}\`](https://github.com/${{ github.repository }}/commit/${{ needs.unified-build.outputs.commit_hash }})" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘:** æ¨é€åˆ°mainåˆ†æ”¯" >> $GITHUB_STEP_SUMMARY

  build-summary:
    runs-on: ubuntu-latest
    needs: [unified-build, preview-package-publish, github-package-publish]
    if: always() && needs.unified-build.outputs.build_success == 'true'
    steps:
      - name: ğŸ“Š ç”Ÿæˆå®Œæ•´æ„å»ºæ‘˜è¦
        run: |
          echo "# ğŸš€ å®Œæ•´æ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # NPM åŒ…ä¿¡æ¯
          if [ "${{ needs.preview-package-publish.result }}" = "success" ]; then
            echo "## ï¿½ NPM é¢„è§ˆåŒ…" >> $GITHUB_STEP_SUMMARY
            echo "- **ç‰ˆæœ¬:** \`${{ needs.preview-package-publish.outputs.pkg_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“¥ å®‰è£…å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.preview-package-publish.outputs.pnpm_install_cmd }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # GitHub Packages ä¿¡æ¯
          if [ "${{ needs.github-package-publish.result }}" = "success" ]; then
            echo "## ğŸ“¦ GitHub Packages" >> $GITHUB_STEP_SUMMARY
            echo "- **çŠ¶æ€:** âœ… å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "- **Registry:** https://npm.pkg.github.com" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi