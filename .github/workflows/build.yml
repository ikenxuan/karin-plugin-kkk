name: CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  id-token: write
  packages: write
  pull-requests: write

jobs:
  # ç‰ˆæœ¬å‘å¸ƒç®¡ç†
  version-release:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release-please.outputs.releases_created }}
      core_release_created: ${{ steps.release-please.outputs['packages/core--release_created'] }}
      core_tag_name: ${{ steps.release-please.outputs['packages/core--tag_name'] }}

    steps:
      - name: ğŸš€ æ‰§è¡Œç‰ˆæœ¬å‘å¸ƒæ£€æŸ¥
        id: release-please
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

  # æ­£å¼ç‰ˆæœ¬æ„å»º (ä»… core åŒ…)
  production-build:
    needs: version-release
    if: needs.version-release.outputs.core_release_created == 'true'
    runs-on: ubuntu-latest
    outputs:
      package_name: ${{ steps.get-package-name.outputs.name }}
      package_short_name: ${{ steps.get-package-name.outputs.PACKAGE_SHORT_NAME }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: ğŸ“¦ é…ç½® PNPM ç¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.13.2
          run_install: |
            - args: [--no-frozen-lockfile]

      - name: ğŸ·ï¸ è§£æåŒ…ä¿¡æ¯
        id: get-package-name
        working-directory: packages/core
        run: |
          PACKAGE_NAME=$(pnpm pkg get name | tr -d '"')
          PACKAGE_SHORT_NAME=$(basename "$PACKAGE_NAME")
          echo "PACKAGE_SHORT_NAME=$PACKAGE_SHORT_NAME" >> $GITHUB_OUTPUT
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ”¨ æ‰§è¡Œå®Œæ•´é¡¹ç›®æ„å»º
        id: build-package
        run: |
          # æ„å»ºæ‰€æœ‰åŒ…ï¼ˆcore å’Œ webï¼‰
          pnpm build
          # å‡†å¤‡ core åŒ…å‘å¸ƒ
          cd packages/core
          pnpm pkg delete devDependencies
          mkdir -p ${{ runner.temp }}/temp/
          cp -r package.json README.md CHANGELOG.md LICENSE config resources lib ${{ runner.temp }}/temp/

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.get-package-name.outputs.PACKAGE_SHORT_NAME }}
          path: ${{ runner.temp }}/temp/

  # NPM æ­£å¼å‘å¸ƒ (ä»… core åŒ…)
  npm-production-publish:
    runs-on: ubuntu-latest
    needs: [version-release, production-build]
    steps:
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.production-build.outputs.package_short_name }}
          path: ./

      - name: ğŸš€ å‘å¸ƒåˆ° NPM å®˜æ–¹æº
        id: publish-to-npm
        uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
          registry: https://registry.npmjs.org/
          access: public
          provenance: true

      - name: ğŸ“Š ç”Ÿæˆå‘å¸ƒæŠ¥å‘Š
        run: |
          echo "## ğŸ“¦ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "åŒ…å: \`${{ steps.publish-to-npm.outputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ç‰ˆæœ¬å·: \`${{ steps.publish-to-npm.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # é•œåƒæºåŒæ­¥
  npm-mirror-sync:
    runs-on: ubuntu-latest
    needs: [npm-production-publish]
    steps:
      - name: ğŸ”„ åŒæ­¥åˆ°å›½å†…é•œåƒæº
        run: |
          curl -X PUT "https://registry-direct.npmmirror.com/-/package/karin-plugin-kkk/syncs"

  # æ„å»ºåˆ†æ”¯åŒæ­¥ (æ„å»ºæ‰€æœ‰åŒ…ï¼Œä½†åªåŒæ­¥ core åŒ…)
  build-branch-sync:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      build_completed: ${{ steps.build-success.outputs.completed }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ é…ç½® PNPM ç¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.7.1
          run_install: |
            - args: [--no-frozen-lockfile]
      
      - name: ğŸ”¨ æ‰§è¡Œå®Œæ•´é¡¹ç›®æ„å»º
        run: |
          echo "å¼€å§‹æ„å»ºæ‰€æœ‰åŒ…..."
          # æ„å»ºæ‰€æœ‰åŒ…ï¼ˆcore å’Œ webï¼‰
          pnpm build
          if [ $? -ne 0 ]; then
            echo "æ„å»ºå¤±è´¥ï¼Œé€€å‡ºå·¥ä½œæµ"
            exit 1
          fi
          echo "æ„å»ºæˆåŠŸï¼Œå‡†å¤‡å¤åˆ¶ core åŒ…æ–‡ä»¶..."
          # å‡†å¤‡ core åŒ…æ–‡ä»¶
          cd packages/core
          pnpm pkg delete devDependencies
          mkdir -p ${{ runner.temp }}/temp/
          # å¤åˆ¶æ‰€æœ‰å¿…è¦æ–‡ä»¶ï¼ŒåŒ…æ‹¬å®Œæ•´çš„ lib ç›®å½•
          cp -r package.json CHANGELOG.md README.md LICENSE resources config lib ${{ runner.temp }}/temp/
          echo "æ–‡ä»¶å·²å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•"

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: sync-build-artifacts
          path: ${{ runner.temp }}/temp/
      
      - name: âœ… æ ‡è®°æ„å»ºå®Œæˆ
        id: build-success
        run: echo "completed=true" >> $GITHUB_OUTPUT
      
      - name: âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          echo "Git ç”¨æˆ·å·²é…ç½®"

      - name: ğŸ”„ åŒæ­¥ä¸»åˆ†æ”¯æœ€æ–°ä»£ç 
        run: |
          echo "è·å–æœ€æ–°çš„ä¸»åˆ†æ”¯..."
          git fetch origin ${{ github.ref_name }}
          git checkout ${{ github.ref_name }}
          git pull origin ${{ github.ref_name }} --ff-only
          echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"

      - name: ğŸ“ è·å–æœ€æ–°æäº¤ä¿¡æ¯
        id: commit-message
        run: |
          echo "è·å–æœ€æ–°æäº¤æ¶ˆæ¯..."
          echo "commit_msg=$(git log origin/${{ github.ref_name }} -1 --pretty=format:'%s')" >> $GITHUB_ENV
          echo "æäº¤æ¶ˆæ¯: ${{ env.commit_msg }}"

      - name: ğŸ” æ£€æŸ¥æ„å»ºåˆ†æ”¯çŠ¶æ€
        id: check-branch
        run: |
          echo "æ£€æŸ¥ç¼–è¯‘åˆ†æ”¯æ˜¯å¦å­˜åœ¨..."
          if git ls-remote --exit-code origin build; then
            echo "branch_exists=true" >> $GITHUB_ENV
            echo "ç¼–è¯‘åˆ†æ”¯å­˜åœ¨"
          else
            echo "branch_exists=false" >> $GITHUB_ENV
            echo "ç¼–è¯‘åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°åˆ†æ”¯"
          fi

      - name: ğŸŒ¿ åˆå§‹åŒ–æ„å»ºåˆ†æ”¯
        run: |          
          echo "å¼€å§‹å¤„ç†ç¼–è¯‘åˆ†æ”¯..."
          if [ "${{ env.branch_exists }}" = "false" ]; then
            echo "åˆ›å»ºæ–°çš„ç¼–è¯‘åˆ†æ”¯..."
            git checkout --orphan build
            git reset --hard
            git clean -fd
            git commit --allow-empty -m "åˆå§‹åŒ–ç¼–è¯‘åˆ†æ”¯"
            git push --set-upstream -f origin build
            echo "æ–°ç¼–è¯‘åˆ†æ”¯å·²åˆ›å»ºå¹¶æ¨é€"
          else
            echo "åˆ‡æ¢åˆ°ç°æœ‰ç¼–è¯‘åˆ†æ”¯..."
            git fetch origin build
            git reset --hard
            git clean -fd
            git reset --hard origin/build
            git checkout build
            echo "å·²åˆ‡æ¢åˆ°ç¼–è¯‘åˆ†æ”¯: $(git branch --show-current)"
          fi

      - name: ğŸ—‚ï¸ å‡†å¤‡æ„å»ºæ–‡ä»¶
        run: |
          echo "å‡†å¤‡æ„å»ºæ–‡ä»¶..."
          # æ¸…ç©ºå½“å‰ç›®å½•ä½†ä¿ç•™.gitæ–‡ä»¶å¤¹
          find . -mindepth 1 -maxdepth 1 -not -name '.git' -exec rm -rf {} \;
          echo "å·²æ¸…ç†ç°æœ‰æ–‡ä»¶ï¼Œä¿ç•™.gitç›®å½•"
          
          # æ˜¾ç¤ºä¸´æ—¶ç›®å½•ä¸­çš„æ–‡ä»¶
          echo "ä¸´æ—¶ç›®å½•ä¸­çš„æ–‡ä»¶:"
          ls -la ${{ runner.temp }}/temp/
          
          # å¤åˆ¶æ„å»ºäº§ç‰©åˆ°å½“å‰ç›®å½•
          echo "å¤åˆ¶æ„å»ºäº§ç‰©..."
          cp -rv ${{ runner.temp }}/temp/* ./
          
      - name: ğŸ“‹ åŒæ­¥å¿…è¦æ–‡ä»¶
        run: |
          # åˆ›å»ºä¸€ä¸ªæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶æ£€å‡ºçš„å‡½æ•°
          checkout_if_exists() {
            echo "æ£€æŸ¥æ–‡ä»¶: packages/core/$1"
            # é¦–å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äº Git æ ‘ä¸­
            if git ls-tree -r --name-only origin/main | grep -q "^packages/core/$1$"; then
              echo "æ–‡ä»¶å­˜åœ¨äº Git ä¸­: packages/core/$1"
              # å°è¯•æ£€å‡ºæ–‡ä»¶ï¼Œå¦‚æœå¤±è´¥åˆ™è·³è¿‡
              if [ "$1" != "package.json" ]; then
                if git checkout main -- "packages/core/$1" 2>/dev/null; then
                  echo "âœ… å·²æ£€å‡º: packages/core/$1"
                else
                  echo "âš ï¸ æ£€å‡ºå¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ: packages/core/$1"
                fi
              else
                echo "â­ï¸ è·³è¿‡æ£€å‡º package.jsonï¼Œä¿ç•™ä¿®æ”¹ç‰ˆæœ¬"
              fi
            else
              echo "ğŸ“ æ–‡ä»¶ä¸å­˜åœ¨äº Git ä¸­ï¼Œè·³è¿‡: packages/core/$1"
            fi
          }
          
          # é€ä¸ªæ£€æŸ¥å¹¶æ£€å‡ºæ–‡ä»¶ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
          echo "å¼€å§‹åŒæ­¥å¿…è¦æ–‡ä»¶..."
          checkout_if_exists "package.json" || true
          checkout_if_exists "CHANGELOG.md" || true
          checkout_if_exists "README.md" || true
          checkout_if_exists "LICENSE" || true
          checkout_if_exists "config" || true
          checkout_if_exists "resources" || true
          echo "æ–‡ä»¶åŒæ­¥å®Œæˆ"

      - name: ğŸ§¹ æ¸…ç†å¼€å‘ä¾èµ–
        run: pnpm pkg delete devDependencies

      - name: ğŸ’¾ æäº¤æ„å»ºç»“æœ
        run: |
          # æ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•çš„çŠ¶æ€
          echo "å½“å‰å·¥ä½œç›®å½•çŠ¶æ€:"
          git status
          
          # æ˜¾ç¤ºä¸æš‚å­˜åŒºçš„å·®å¼‚
          echo "ä¸æš‚å­˜åŒºçš„å·®å¼‚:"
          git diff
          
          git add .
          
          # æ˜¾ç¤ºå·²æš‚å­˜çš„å˜æ›´
          echo "å·²æš‚å­˜çš„å˜æ›´:"
          git diff --cached
          
          if [ -z "$(git diff --cached --name-only)" ]; then
            echo "No changes detected"
            exit 0
          else
            git commit -m "chore(build): ${{ github.event.head_commit.message }}"
          fi

      - name: ğŸ”— è®¾ç½®åˆ†æ”¯ä¸Šæ¸¸å…³è”
        run: git push --set-upstream origin build

      - name: ğŸš€ æ¨é€åˆ°æ„å»ºåˆ†æ”¯
        uses: ad-m/github-push-action@master
        with:
          branch: build
          github_token: ${{ secrets.GITHUB_TOKEN }}
          force_with_lease: true
          args: --set-upstream

  # é¢„è§ˆåŒ…å‘å¸ƒ (æ¯æ¬¡æ¨é€éƒ½æ‰§è¡Œ)
  preview-package-publish:
    runs-on: ubuntu-latest
    # ç§»é™¤æ¡ä»¶é™åˆ¶ï¼Œæ¯æ¬¡æ¨é€éƒ½æ‰§è¡Œ
    steps:
      - name: ğŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ é…ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 21
          registry-url: "https://registry.npmjs.org"

      - name: ğŸ“¦ é…ç½® PNPM ç¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.7.1

      - name: â³ ç­‰å¾…æ„å»ºåˆ†æ”¯åŒæ­¥å®Œæˆ
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.ref }}
          check-name: 'build-branch-sync'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰© (ä¸»åˆ†æ”¯)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/download-artifact@v4
        with:
          name: sync-build-artifacts
          path: ./build-output/

      - name: ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–
        if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        run: pnpm install

      - name: ğŸ”¨ æ‰§è¡Œå®Œæ•´é¡¹ç›®æ„å»º
        if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
        run: |
          # æ„å»ºæ‰€æœ‰åŒ…ï¼ˆcore å’Œ webï¼‰
          pnpm build
          if [ $? -ne 0 ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼" >> $GITHUB_STEP_SUMMARY
            echo "æäº¤å“ˆå¸Œ: $(git rev-parse --short HEAD)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          # å‡†å¤‡ core åŒ…å‘å¸ƒ
          cd packages/core
          pnpm pkg delete devDependencies
          # å›åˆ°æ ¹ç›®å½•å‡†å¤‡å‘å¸ƒ
          cd ../..
          # å¤åˆ¶æ„å»ºäº§ç‰©åˆ°æ ¹ç›®å½•
          cp -r packages/core/lib ./
          cp -r packages/core/config ./
          cp -r packages/core/resources ./
          cp packages/core/package.json ./
          cp packages/core/README.md ./
          cp packages/core/CHANGELOG.md ./
          cp packages/core/LICENSE ./

      - name: ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ ‡è¯†
        run: |
          # åŸºç¡€ä¿¡æ¯
          COMMIT_HASH=$(git rev-parse HEAD)
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          TIMESTAMP=$(date +%s)
          
          # åˆ†æ”¯ä¿¡æ¯
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
            PR_NUMBER="${{ github.event.number }}"
            echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          
          # å¯¼å‡ºç¯å¢ƒå˜é‡
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "SHORT_COMMIT_HASH=$SHORT_COMMIT_HASH" >> $GITHUB_ENV
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "REPO_URL=https://github.com/${{ github.repository }}/tree/$COMMIT_HASH" >> $GITHUB_ENV
          
          echo "æäº¤å“ˆå¸Œ: $SHORT_COMMIT_HASH"
          echo "æäº¤è®¡æ•°: $COMMIT_COUNT"
          echo "åˆ†æ”¯åç§°: $BRANCH_NAME"

      - name: ğŸ“¦ å‡†å¤‡é¢„è§ˆåŒ…
        run: |
          # å¦‚æœæ˜¯mainåˆ†æ”¯æäº¤ï¼Œå¤åˆ¶æ„å»ºäº§ç‰©ï¼›å¦åˆ™ä½¿ç”¨å½“å‰ç›®å½•
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ä½¿ç”¨æ„å»ºåˆ†æ”¯åŒæ­¥çš„äº§ç‰©"
            cp -r build-output/* ./
          else
            echo "ä½¿ç”¨å½“å‰æ„å»ºçš„äº§ç‰©"
          fi
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          SHORT_COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          TIMESTAMP=$(date +%s)
          
          # è§£æå½“å‰ç‰ˆæœ¬å·
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)
          
          # æ ¹æ®ä¸åŒåœºæ™¯ç”Ÿæˆç‰ˆæœ¬å·
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # æ£€æŸ¥æ˜¯å¦ä¸º release-please åˆ›å»ºçš„ PR
            if [[ "${{ github.head_ref }}" == release-please--branches--* ]]; then
              # Release-please PRï¼šrc.æäº¤åºå·
              PR_COMMIT_COUNT=$(git rev-list --count HEAD ^origin/main)
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-rc.${PR_COMMIT_COUNT}"
            else
              # æ™®é€š PR ç‰ˆæœ¬ï¼šalpha.PRç¼–å·.æäº¤åºå·
              PR_NUMBER=${{ github.event.number }}
              PR_COMMIT_COUNT=$(git rev-list --count HEAD ^origin/main)
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-alpha.${PR_NUMBER}.${PR_COMMIT_COUNT}"
            fi
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # ä¸»åˆ†æ”¯ï¼šbeta.æäº¤è®¡æ•°.æ—¶é—´æˆ³å4ä½
            TIME_SUFFIX=$(echo $TIMESTAMP | tail -c 5)
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-beta.${COMMIT_COUNT}.${TIME_SUFFIX}"
          else
            # å…¶ä»–åˆ†æ”¯ï¼šdev.åˆ†æ”¯å.æäº¤å“ˆå¸Œ
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-dev.${BRANCH_NAME}.${SHORT_COMMIT_HASH}"
          fi
          
          npm version $NEW_VERSION --no-git-tag-version
          echo "PKG_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "ç”Ÿæˆçš„ç‰ˆæœ¬å·: $NEW_VERSION"

      - name: ğŸš€ å‘å¸ƒé¢„è§ˆåŒ…
        id: publish_pkg
        run: |
          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)
          
          pnpm dlx pkg-pr-new publish --json output.json --comment=update --compact --packageManager=pnpm > pkg-output.txt 2>&1
          echo "å‘½ä»¤è¾“å‡ºå†…å®¹ï¼š"
          cat pkg-output.txt
          
          ACTUAL_INSTALL_URL=$(grep -oE 'https://pkg\.pr\.new/[^[:space:]`]+' pkg-output.txt | head -n 1 || echo "")
          
          if [ ! -z "$ACTUAL_INSTALL_URL" ]; then
            PNPM_INSTALL_CMD="pnpm add ${ACTUAL_INSTALL_URL} -w"
          else
            PNPM_INSTALL_CMD="æœªæ‰¾åˆ°å®‰è£…å‘½ä»¤"
            ACTUAL_INSTALL_URL="æœªæ‰¾åˆ°å®‰è£…URL"
          fi
          
          echo "pnpm_install_cmd=$PNPM_INSTALL_CMD" >> $GITHUB_OUTPUT
          echo "install_url=$ACTUAL_INSTALL_URL" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆç®€åŒ–çš„å®‰è£…URL
          REPO_NAME="${{ github.event.repository.name }}"
          SIMPLIFIED_URL="https://pkg.pr.new/${REPO_NAME}@${{ env.SHORT_COMMIT_HASH }}"
          echo "simplified_url=$SIMPLIFIED_URL" >> $GITHUB_OUTPUT
          
          # è·å– Stackblitz URL
          STACKBLITZ_URL=""
          if [ -f "output.json" ]; then
            STACKBLITZ_URL=$(node -p "try { const data = require('./output.json'); data.templates && data.templates[0] ? data.templates[0].url : ''; } catch(e) { ''; }" || echo "")
          fi
          echo "stackblitz_url=$STACKBLITZ_URL" >> $GITHUB_OUTPUT
          
          # è®¡ç®—æ—¶é—´ï¼ˆè½¬æ¢ä¸º CST æ—¶åŒºï¼‰
          PACK_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          echo "pack_time=$PACK_TIME" >> $GITHUB_OUTPUT
          
          # è®¡ç®—å½“å‰æ—¶é—´æˆ³ï¼ˆç”¨äºè®¡ç®—æ—¶é—´å·®ï¼‰
          CURRENT_TIMESTAMP=$(date +%s)
          echo "current_timestamp=$CURRENT_TIMESTAMP" >> $GITHUB_OUTPUT
          
          # è®¡ç®—æ„å»ºè€—æ—¶
          END_TIME=$(date +%s)
          BUILD_DURATION=$((END_TIME - START_TIME))
          BUILD_DURATION_MIN=$((BUILD_DURATION / 60))
          BUILD_DURATION_SEC=$((BUILD_DURATION % 60))
          if [ $BUILD_DURATION_MIN -gt 0 ]; then
            DURATION_TEXT="${BUILD_DURATION_MIN}åˆ†${BUILD_DURATION_SEC}ç§’"
          else
            DURATION_TEXT="${BUILD_DURATION_SEC}ç§’"
          fi
          echo "build_duration=$DURATION_TEXT" >> $GITHUB_OUTPUT
          
          # è·å–å‡†ç¡®çš„ Node.js ç‰ˆæœ¬
          NODE_VERSION=$(node --version)
          echo "node_version=$NODE_VERSION" >> $GITHUB_OUTPUT
          
          # è·å–å‡†ç¡®çš„ PNPM ç‰ˆæœ¬
          PNPM_VERSION=$(pnpm --version)
          echo "pnpm_version=$PNPM_VERSION" >> $GITHUB_OUTPUT
          
          # è·å–æäº¤ä¿¡æ¯
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          
          # è·å–æ–‡ä»¶å˜æ›´ç»Ÿè®¡
          FILES_CHANGED=$(git diff --name-only HEAD~1 HEAD | wc -l)
          LINES_ADDED=$(git diff --numstat HEAD~1 HEAD | awk '{added += $1} END {print added+0}')
          LINES_DELETED=$(git diff --numstat HEAD~1 HEAD | awk '{deleted += $2} END {print deleted+0}')
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_deleted=$LINES_DELETED" >> $GITHUB_OUTPUT
          
          echo "## ğŸ“¦ é¢„è§ˆåŒ…å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "ç‰ˆæœ¬å·: \`${{ env.PKG_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å®‰è£…å‘½ä»¤:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$PNPM_INSTALL_CMD" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## å®Œæ•´è¾“å‡º" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat pkg-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ æ›´æ–° PR è¯„è®º
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## ğŸ“¦ é¢„è§ˆåŒ…å‘å¸ƒæˆåŠŸ 
            
            ### ğŸ·ï¸ åŒ…ä¿¡æ¯
            - **ç‰ˆæœ¬å·:** `${{ env.PKG_VERSION }}`
            - **æäº¤å“ˆå¸Œ:** [`${{ env.SHORT_COMMIT_HASH }}`](${{ env.REPO_URL }})
            - **åˆ†æ”¯:** `${{ github.head_ref || github.ref_name }}`
            
            ### ğŸ“¥ å®‰è£…æ–¹å¼
            ```bash
            # æ¨èä½¿ç”¨ pnpm å®‰è£…
            ${{ steps.publish_pkg.outputs.pnpm_install_cmd }}
            ```
            
            ### ğŸš€ å¿«é€Ÿä½“éªŒ
            ${{ steps.publish_pkg.outputs.stackblitz_url && format('- [ğŸŒ åœ¨ Stackblitz ä¸­æ‰“å¼€]({0})', steps.publish_pkg.outputs.stackblitz_url) || '- ğŸŒ Stackblitz é“¾æ¥æš‚ä¸å¯ç”¨' }}
            - [ğŸ“‹ æŸ¥çœ‹æ„å»ºæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ğŸ” æŸ¥çœ‹æäº¤è¯¦æƒ…](${{ env.REPO_URL }})
            
            ### ğŸ“Š æœ¬æ¬¡å˜æ›´
            - **æäº¤ä¿¡æ¯:** ${{ steps.publish_pkg.outputs.commit_message }}
            - **æäº¤ä½œè€…:** ${{ steps.publish_pkg.outputs.commit_author }}
            - **æ–‡ä»¶å˜æ›´:** ${{ steps.publish_pkg.outputs.files_changed }} ä¸ªæ–‡ä»¶
            - **ä»£ç å˜æ›´:** +${{ steps.publish_pkg.outputs.lines_added }} -${{ steps.publish_pkg.outputs.lines_deleted }} è¡Œ
            
            ### â° æ—¶é—´ä¿¡æ¯
            - **ğŸ“¦ æ‰“åŒ…æ—¶é—´:** `${{ steps.publish_pkg.outputs.pack_time }} (CST)`
            - **ğŸ”„ è¯„è®ºæ›´æ–°:** `${{ steps.publish_pkg.outputs.pack_time }} (CST)`
            - **âš¡ æ„å»ºè€—æ—¶:** ${{ steps.publish_pkg.outputs.build_duration }}
            
            ### ğŸ› ï¸ ç¯å¢ƒä¿¡æ¯
            - **Node.js:** `${{ steps.publish_pkg.outputs.node_version }}`
            - **PNPM:** `${{ steps.publish_pkg.outputs.pnpm_version }}`
            - **æ„å»ºå¹³å°:** `ubuntu-latest`
            - **å·¥ä½œæµ:** `${{ github.workflow }}`
            
            ---
            
            <details>
            <summary>ğŸ”§ é«˜çº§é€‰é¡¹</summary>
            
            #### ğŸ“‹ å®Œæ•´å®‰è£… URL
            ```
            ${{ steps.publish_pkg.outputs.install_url }}
            ```
            
            #### ğŸƒâ€â™‚ï¸ å¿«é€Ÿæµ‹è¯•å‘½ä»¤
            ```bash
            # åˆ›å»ºæµ‹è¯•ç›®å½•
            mkdir test-${{ env.SHORT_COMMIT_HASH }}
            cd test-${{ env.SHORT_COMMIT_HASH }}
            
            # åˆå§‹åŒ–é¡¹ç›®
            npm init -y
            
            # å®‰è£…é¢„è§ˆåŒ…
            ${{ steps.publish_pkg.outputs.pnpm_install_cmd }}
            
            # æµ‹è¯•å¯¼å…¥
            node -e "console.log(require('${{ github.event.repository.name }}'))"
            ```
            
            </details>
            
            > ğŸ’¡ **æç¤º:** æ­¤è¯„è®ºä¼šåœ¨æ¯æ¬¡æ¨é€æ–°æäº¤æ—¶è‡ªåŠ¨æ›´æ–°ï¼ŒåŒ…å«æœ€æ–°çš„æ„å»ºä¿¡æ¯
          comment-tag: published-packages
          mode: upsert
          reactions: rocket, eyes, hooray

      - name: ä¸Šä¼ NPMåŒ…ä¿¡æ¯
        uses: actions/upload-artifact@v4
        with:
          name: npm-package-info
          path: |
            pkg-output.txt
            output.json

      - name: åˆ›å»ºåˆ†å‘åŒ…
        run: |
          mkdir -p temp-package
          cp -r lib temp-package/
          cp -r resources temp-package/
          cp package.json CHANGELOG.md README.md LICENSE temp-package/
          cp -r config temp-package/ || true
          cd temp-package
          zip -r ../build.zip .
          cd ..
          rm -rf temp-package

      - name: ä¸Šä¼ åˆ†å‘åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: build-zip
          path: build.zip