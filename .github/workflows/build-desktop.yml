name: æž„å»ºWindowsæ¡Œé¢åº”ç”¨ç¨‹åº

on:
  workflow_call:
    inputs:
      core_version:
        description: 'CoreåŒ…ç‰ˆæœ¬å·'
        required: true
        type: string
      should_upload_release:
        description: 'æ˜¯å¦ä¸Šä¼ åˆ°Release'
        required: false
        type: boolean
        default: false
      release_tag_name:
        description: 'Releaseæ ‡ç­¾åç§°'
        required: false
        type: string
    outputs:
      exe_path:
        description: 'Windows exeæ–‡ä»¶è·¯å¾„'
        value: ${{ jobs.build-windows-desktop.outputs.exe_path }}
      exe_name:
        description: 'Windows exeæ–‡ä»¶å'
        value: ${{ jobs.build-windows-desktop.outputs.exe_name }}
      desktop_version:
        description: 'æ¡Œé¢åº”ç”¨ç‰ˆæœ¬å·'
        value: ${{ jobs.build-windows-desktop.outputs.desktop_version }}

jobs:
  build-windows-desktop:
    name: æž„å»ºWindowsæ¡Œé¢åº”ç”¨
    runs-on: windows-latest
    outputs:
      exe_path: ${{ steps.build.outputs.exe_path }}
      exe_name: ${{ steps.build.outputs.exe_name }}
      desktop_version: ${{ steps.sync-version.outputs.desktop_version }}

    steps:
      - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: ðŸ’¾ ç¼“å­˜Rustä¾èµ–
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/web/src-tauri
          cache-on-failure: true
          shared-key: "desktop-build"

      - name: ðŸ“¦ é…ç½®PNPMçŽ¯å¢ƒ
        uses: pnpm/action-setup@v4
        with:
          version: 9.13.2

      - name: ðŸŸ¢ é…ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 21
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ðŸ”„ åŒæ­¥ç‰ˆæœ¬å·åˆ°æ¡Œé¢åº”ç”¨é…ç½®
        id: sync-version
        run: |
          $CORE_VERSION = "${{ inputs.core_version }}"
          echo "åŒæ­¥ç‰ˆæœ¬å·: $CORE_VERSION"
          
          # æ›´æ–° tauri.conf.json ä¸­çš„ç‰ˆæœ¬å·
          $configPath = "packages/web/src-tauri/tauri.conf.json"
          $config = Get-Content $configPath | ConvertFrom-Json
          $config.version = $CORE_VERSION
          $config | ConvertTo-Json -Depth 10 | Set-Content $configPath
          
          # æ›´æ–° Cargo.toml ä¸­çš„ç‰ˆæœ¬å·
          $cargoPath = "packages/web/src-tauri/Cargo.toml"
          (Get-Content $cargoPath) -replace '^version = ".*"', "version = `"$CORE_VERSION`"" | Set-Content $cargoPath
          
          echo "desktop_version=$CORE_VERSION" >> $env:GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·å·²åŒæ­¥ä¸º: $CORE_VERSION"

      - name: ðŸ“± æž„å»ºWindowsæ¡Œé¢åº”ç”¨
        id: build
        run: |
          echo "å¼€å§‹æž„å»ºWindowsæ¡Œé¢åº”ç”¨..."
          pnpm run build:desktop --target x86_64-pc-windows-msvc
          echo "Windowsæ¡Œé¢åº”ç”¨æž„å»ºå®Œæˆ"
          
          # æŸ¥æ‰¾NSISå®‰è£…ç¨‹åº
          $NSIS_PATH = Get-ChildItem -Path "packages/web/src-tauri/target" -Recurse -Filter "*.exe" | Where-Object { $_.FullName -like "*bundle*nsis*" } | Select-Object -First 1 -ExpandProperty FullName
          
          if ($NSIS_PATH) {
            $NSIS_NAME = Split-Path $NSIS_PATH -Leaf
            echo "exe_path=$NSIS_PATH" >> $env:GITHUB_OUTPUT
            echo "exe_name=$NSIS_NAME" >> $env:GITHUB_OUTPUT
            echo "æ‰¾åˆ°NSISå®‰è£…ç¨‹åº: $NSIS_PATH"
            echo "æ–‡ä»¶å: $NSIS_NAME"
          } else {
            echo "é”™è¯¯: æœªæ‰¾åˆ°NSISå®‰è£…ç¨‹åº"
            exit 1
          }

      - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.exe_name }}
          path: ${{ steps.build.outputs.exe_path }}
          retention-days: 30
          compression-level: 0

      - name: ðŸš€ ä¸Šä¼ åˆ°Release
        if: inputs.should_upload_release && inputs.release_tag_name && steps.build.outputs.exe_path
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag_name }}
          files: ${{ steps.build.outputs.exe_path }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š ç”Ÿæˆæž„å»ºæ‘˜è¦
        run: |
          echo "## ðŸ–¥ï¸ Windowsæ¡Œé¢åº”ç”¨æž„å»ºå®Œæˆ" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### ðŸ“± åº”ç”¨ä¿¡æ¯" >> $env:GITHUB_STEP_SUMMARY
          echo "- **å¹³å°:** Windows x64" >> $env:GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶å:** ``${{ steps.build.outputs.exe_name }}``" >> $env:GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** ``${{ steps.sync-version.outputs.desktop_version }}``" >> $env:GITHUB_STEP_SUMMARY
          echo "- **åŸºäºŽCoreç‰ˆæœ¬:** ``${{ inputs.core_version }}``" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½æ–¹å¼" >> $env:GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **Artifactä¸‹è½½:** [ç‚¹å‡»ä¸‹è½½ ${{ steps.build.outputs.exe_name }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $env:GITHUB_STEP_SUMMARY
          if ("${{ inputs.should_upload_release }}" -eq "true" -and "${{ inputs.release_tag_name }}" -ne "") {
            echo "- ðŸš€ **Releaseä¸‹è½½:** [ç‚¹å‡»è¿™é‡Œä¸‹è½½æœ€æ–°ç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/tag/${{ inputs.release_tag_name }})" >> $env:GITHUB_STEP_SUMMARY
          }
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ æž„å»ºè¯¦æƒ…" >> $env:GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" >> $env:GITHUB_STEP_SUMMARY
          echo "- **æäº¤SHA:** ``${{ github.sha }}``" >> $env:GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯:** ``${{ github.ref_name }}``" >> $env:GITHUB_STEP_SUMMARY