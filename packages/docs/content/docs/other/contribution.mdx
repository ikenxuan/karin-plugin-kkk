---
title: 贡献指南
description: 欢迎参与 karin-plugin-kkk 的开发与贡献
---

import { Callout } from 'fumadocs-ui/components/callout';
import { Steps, Step } from 'fumadocs-ui/components/steps';
import { Mermaid } from '@/components/Mermaid';

# 贡献指南

感谢你对 **karin-plugin-kkk** 感兴趣！我们需要你的帮助来让这个项目变得更好。

无论是修复 Bug、添加新功能，还是改进文档，我们都非常欢迎。

## 准备工作

在开始之前，请确保你的开发环境满足以下要求：

- **[Node.js](https://nodejs.org/)**: >= 22
- **[pnpm](https://pnpm.io/)**: >= 9
- **[Git](https://git-scm.com/)**: 版本控制工具

## 项目结构

本项目采用 **[Monorepo](https://monorepo.tools/)** 结构，主要包含以下部分：

- `packages/core`: 核心插件代码 (`karin-plugin-kkk`)，包含主要业务逻辑。
- `packages/template`: [React](https://react.dev/) SSR 渲染器，生成 HTML 文件。
- `packages/amagi`: 接口库 (**[Git Submodule](https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%AD%90%E6%A8%A1%E5%9D%97)**)，处理各平台的 API 请求与签名。
- `packages/docs`: 文档站点，基于 [Next.js](https://nextjs.org/) 和 [Fumadocs](https://fumadocs.vercel.app/)。

<Callout type="warn">
`packages/amagi` 是一个 **Git 子模块**。如果你需要修改 API 相关的逻辑（如签名算法），请**不要直接修改该目录**。你需要前往 [amagi 仓库](https://github.com/ikenxuan/amagi) 提交 Pull Request。
</Callout>

## 架构说明

### 插件在 Karin 中的位置

`karin-plugin-kkk` 是 Karin 框架的一个功能插件，遵循 Karin 的插件规范开发。

<Mermaid chart={`
flowchart TB
    subgraph Karin["Karin 框架"]
        direction TB
        Core["Karin Core"]
        EventBus["事件总线"]
        PluginLoader["插件加载器"]
        Adapters["适配器层"]
    end

    subgraph Adapters
        ICQQ["ICQQ"]
        NapCat["NapCat"]
        LLOneBot["LLOneBot"]
        Lagrange["Lagrange"]
        Others["..."]
    end

    subgraph Plugin["karin-plugin-kkk"]
        direction TB
        Apps["Apps 命令层"]
        Platform["Platform 平台层"]
        Module["Module 工具层"]
        Amagi["Amagi 解析库"]
    end

    QQ["QQ / 其他 IM"] <--> Adapters
    Adapters <--> Core
    Core <--> EventBus
    EventBus <--> PluginLoader
    PluginLoader --> Plugin
    Apps --> Platform
    Platform --> Module
    Platform --> Amagi
`} />

### 消息处理流程

当用户在群聊中发送包含平台链接的消息时，插件的处理流程如下：

<Mermaid chart={`
sequenceDiagram
    participant User as 用户
    participant QQ as QQ客户端
    participant Adapter as 适配器
    participant Karin as Karin Core
    participant Plugin as karin-plugin-kkk
    participant Platform as 平台API
    participant Render as 渲染器

    User->>QQ: 发送分享链接
    QQ->>Adapter: 消息上报
    Adapter->>Karin: 标准化消息
    Karin->>Plugin: 触发命令匹配
    
    Plugin->>Plugin: 解析链接获取ID
    Plugin->>Platform: 请求作品数据
    Platform-->>Plugin: 返回视频/图文数据
    Plugin->>Platform: 请求评论数据
    Platform-->>Plugin: 返回评论列表
    
    Plugin->>Render: 渲染评论图片
    Render-->>Plugin: 返回图片
    
    Plugin->>Karin: 发送消息
    Karin->>Adapter: 转发消息
    Adapter->>QQ: 发送到群聊
    QQ->>User: 展示解析结果
`} />

### 核心模块说明

**Apps 命令层** - 负责注册 Karin 命令，监听消息并分发到对应的平台处理器。

```
src/apps/
├── tools.ts      # 视频解析命令（抖音/B站/快手/小红书）
├── push.ts       # 动态推送任务
├── qrlogin.ts    # 扫码登录功能
├── admin.ts      # 管理员命令
├── help.ts       # 帮助信息
└── update.ts     # 插件更新
```

**Platform 平台层** - 每个平台独立封装，包含链接解析、数据获取、评论处理等。

```
src/platform/
├── douyin/       # 抖音
├── bilibili/     # B站
├── kuaishou/     # 快手
└── xiaohongshu/  # 小红书
```

**Module 工具层** - 提供配置管理、数据库操作、API 服务、网络请求等通用功能。

```
src/module/
├── config/       # 配置管理
├── db/           # 数据库操作
├── server/       # API 服务
└── utils/        # 工具函数
```

### 数据流向

<Mermaid chart={`
flowchart LR
    subgraph Input["输入"]
        Link["分享链接"]
    end

    subgraph Process["处理"]
        Parse["链接解析"]
        Fetch["数据获取"]
        Transform["数据转换"]
    end

    subgraph Output["输出"]
        Video["视频文件"]
        Image["评论图片"]
        Info["作品信息"]
    end

    Link --> Parse
    Parse --> Fetch
    Fetch --> Transform
    Transform --> Video
    Transform --> Image
    Transform --> Info
`} />

## 开发流程

<Steps>
<Step>

### Fork 本仓库

点击项目主页右上角的 [**Fork**](https://github.com/ikenxuan/karin-plugin-kkk/fork) 按钮，将仓库 Fork 到你的 GitHub 账户下。

</Step>
<Step>

### 克隆仓库

将你 Fork 后的仓库克隆到本地。由于项目包含子模块，克隆时需要初始化子模块：

```bash
# 替换为你的 GitHub 用户名
git clone --recursive https://github.com/你的用户名/karin-plugin-kkk.git

# 或者如果你已经克隆了仓库但没有子模块
git submodule update --init --recursive
```

</Step>
<Step>

### 安装依赖

使用 pnpm 安装所有依赖：

```bash
pnpm install
```

</Step>
<Step>

### 启动开发环境

根据你要修改的内容，启动相应的开发环境：

- **开发插件核心 (`packages/core`)**:
  ```bash
  pnpm watch
  ```

- **开发模板 (`packages/template`)**:
  ```bash
  pnpm template
  ```

- **预览文档 (`packages/docs`)**:
  ```bash
  pnpm docs
  ```

</Step>
<Step>

### 提交代码

我们遵循 [Conventional Commits](https://www.conventionalcommits.org/zh-hans/v1.0.0/) 规范。

提交信息的格式如下：

```
<type>(<scope>): <subject>
```

例如：
- `feat(core): 支持解析新的分享链接`
- `fix(template): 修复动态卡片样式错乱`
- `docs: 更新贡献指南`

</Step>
<Step>

### 提交 Pull Request

1. 推送到你的 Fork 仓库：
   ```bash
   git push origin feature/amazing-feature
   ```
2. 在 GitHub 上向原仓库提交 Pull Request。

</Step>
</Steps>

## 常见问题

### 如何更新子模块？

如果你发现 `packages/amagi` 落后于上游，可以使用以下命令更新：

```bash
git submodule update --remote
```

### 遇到 TypeScript 类型错误？

尝试重新构建整个项目或重新安装依赖：

```bash
pnpm install
pnpm build
```